<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 0;
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #dee2e6;
            max-height: 1200px;
            overflow-y: auto;
        }
        
        .main {
            padding: 30px;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .control-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .value-display {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .value-display.highlight {
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card h3 {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 1.6em;
            font-weight: 700;
        }
        
        .section-divider {
            margin: 20px 0;
            border-top: 2px solid #dee2e6;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .info-box h4 {
            color: #0066cc;
            margin-bottom: 8px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .warning-box h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p>å¯¾æ•°æ­£è¦åˆ†å¸ƒãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹è³‡ç”£åˆ†å¸ƒã¨çµ±è¨ˆçš„å„ªä½æ€§ã®å¯è¦–åŒ–</p>
            <p style="font-size: 0.9em; opacity: 0.9; margin-top: 8px;">
                ğŸ’¡ åˆæœŸå€¤ã¯SOXLï¼ˆåŠå°ä½“3å€ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFï¼‰ã«åˆã‚ã›ã¦è¨­å®šã—ã¦ã„ã¾ã™
            </p>
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.95em;">
                <strong>ğŸ’° Lå€ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã®è¤‡åˆ©è¾¼ã¿å¹³å‡å¹´åˆ©ï¼ˆå€ï¼‰ã®åŸå‰‡</strong><br>
                <div id="formula-display" style="margin-top: 15px; font-size: 1.3em; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 5px; text-align: center;">
                    <!-- MathJax formula will be rendered here -->
                </div>
                <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; font-size: 0.9em;">
                    <div>â‘ å¢—ä¾¡<br><span id="label-1"></span></div>
                    <div>â‘¡æ¸›ä¾¡<br><span id="label-2"></span></div>
                    <div>â‘¢é‡‘åˆ©<br><span id="label-3"></span></div>
                    <div>â‘£çµŒè²»<br><span id="label-4"></span></div>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <h2 style="margin-bottom: 20px; color: #667eea;">âš™ï¸ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š</h2>
                
                <div class="control-group">
                    <label>â±ï¸ æŠ•è³‡æœŸé–“ (Tå¹´) <span class="value-display highlight" id="T-value">1</span></label>
                    <input type="range" id="T" min="1" max="20" step="1" value="1">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        æœŸé–“ãŒé•·ã„ã»ã©åˆ†å¸ƒãŒåºƒãŒã‚Šã¾ã™
                    </small>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>ãƒ¬ãƒãƒ¬ãƒƒã‚¸ (L) <span class="value-display" id="L-value">3.0</span></label>
                    <input type="range" id="L" min="1" max="5" step="0.1" value="3.0">
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>ãƒ‰ãƒªãƒ•ãƒˆ (Î¼) <span class="value-display" id="mu-value">0.14</span></label>
                    <input type="range" id="mu" min="0" max="0.3" step="0.01" value="0.14">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        å¹´é–“æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³ç‡
                    </small>
                </div>
                
                <div class="control-group">
                    <label>ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ (Ïƒ) <span class="value-display" id="sigma-value">0.34</span></label>
                    <input type="range" id="sigma" min="0.01" max="0.5" step="0.01" value="0.34">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        å¹´é–“å¤‰å‹•ç‡
                    </small>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>é‡‘åˆ© (b) <span class="value-display" id="b-value">0.030</span></label>
                    <input type="range" id="b" min="0" max="0.1" step="0.005" value="0.03">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã‚³ã‚¹ãƒˆ
                    </small>
                </div>
                
                <div class="control-group">
                    <label>çµŒè²» (c) <span class="value-display" id="c-value">0.0095</span></label>
                    <input type="range" id="c" min="0" max="0.1" step="0.0005" value="0.0095">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        å¹´é–“é‹ç”¨çµŒè²»ç‡
                    </small>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>ğŸ² ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•° <span class="value-display highlight" id="simulations-value">100</span></label>
                    <input type="range" id="simulations" min="10" max="500" step="10" value="100">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã®è©¦è¡Œå›æ•°ï¼ˆ10ã€œ500å›ã€å¤šã„ã»ã©ç²¾åº¦å‘ä¸Šï¼‰
                    </small>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>ğŸ“ ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«Yè»¸æœ€å¤§å€¤ <span class="value-display" id="ymax-value">1000</span></label>
                    <input type="range" id="ymax" min="100" max="5000" step="100" value="1000">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã®ã‚°ãƒ©ãƒ•3ã®Yè»¸ä¸Šé™ï¼ˆä¸‡å††ï¼‰
                    </small>
                </div>
                
                <div class="info-box" style="margin-top: 30px;">
                    <h4>ğŸ’¡ æŠ•è³‡æœŸé–“ã®å½±éŸ¿</h4>
                    <p style="font-size: 0.9em;">
                        æœŸé–“ãŒé•·ã„ã»ã©ï¼š<br>
                        â€¢ åˆ†å¸ƒãŒæ¨ªã«åºƒãŒã‚‹<br>
                        â€¢ æœŸå¾…å€¤ã¨æœ€é »å€¤ã®ä¹–é›¢ãŒæ‹¡å¤§<br>
                        â€¢ ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æ¸›ä¾¡ãŒé¡•è‘—ã«
                    </p>
                </div>
                
                <div class="warning-box">
                    <h4>âš ï¸ æ³¨æ„</h4>
                    <p style="font-size: 0.9em;">
                        é•·æœŸæŠ•è³‡ã§ã¯è¤‡åˆ©åŠ¹æœã¨ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æ¸›ä¾¡ã®ä¸¡æ–¹ãŒå½±éŸ¿ã—ã¾ã™
                    </p>
                </div>
                
                <div class="info-box" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <h4 style="color: #2e7d32;">âœ… ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«</h4>
                    <p style="font-size: 0.9em;">
                        <strong>æ—¥æ¬¡ãƒªãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ‡ãƒ«</strong>ã‚’æ¡ç”¨<br>
                        â€¢ åŸæŒ‡æ•°ã®æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ã‚’Lå€<br>
                        â€¢ æ¯æ—¥ã‚³ã‚¹ãƒˆã‚’æ§é™¤<br>
                        â€¢ å®Ÿéš›ã®ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã®å‹•ä½œã«è¿‘ä¼¼
                    </p>
                </div>
            </div>
            
            <div class="main">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>æŠ•è³‡æœŸé–“</h3>
                        <div class="value" id="period-display">1å¹´</div>
                    </div>
                    <div class="stat-card">
                        <h3>ãƒªã‚¹ã‚¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </h3>
                        <div class="value" id="risk-premium">0.180</div>
                    </div>
                    <div class="stat-card">
                        <h3>ä¸­å¤®å€¤å„ªä½ä¸Šé™</h3>
                        <div class="value" id="median-limit">L = 8.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>æœ€é »å€¤å„ªä½ä¸Šé™</h3>
                        <div class="value" id="mode-limit">L = 2.00</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ“ˆ ã‚°ãƒ©ãƒ•1: è³‡ç”£åˆ†å¸ƒã®æ¯”è¼ƒï¼ˆæŠ•è³‡æœŸé–“: <span id="chart1-period">1</span>å¹´å¾Œï¼‰</div>
                    <div id="distribution-chart"></div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                            <div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">æœŸå¾…å€¤æ¯”</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="mean-ratio">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">ä¸­å¤®å€¤æ¯”</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #28a745;" id="median-ratio">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">æœ€é »å€¤æ¯”</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;" id="mode-ratio">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ¯ ã‚°ãƒ©ãƒ•2: çµ±è¨ˆçš„å„ªä½ã‚¾ãƒ¼ãƒ³ï¼ˆæœŸé–“ã«ä¾å­˜ã—ãªã„ï¼‰</div>
                    <div id="zones-chart"></div>
                </div>
                
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="chart-title" style="margin-bottom: 0;">ğŸ² ã‚°ãƒ©ãƒ•3: ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåˆæœŸæŠ•è³‡100ä¸‡å††ã€æŠ•è³‡æœŸé–“: <span id="chart3-period">1</span>å¹´ã€<span id="chart3-simulations">100</span>å›è©¦è¡Œã€æ—¥æ¬¡è¨ˆç®—ãƒ»252å–¶æ¥­æ—¥/å¹´ï¼‰</div>
                        <div>
                            <button id="toggle-log-scale" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆ‡æ›¿
                            </button>
                        </div>
                    </div>
                    <div id="montecarlo-chart"></div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px; font-size: 1em;">L=1 é€šå¸¸ETF (<span id="sim-count-1">100</span>å›ã®çµæœ)</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div style="color: #666;">å¹³å‡å€¤:</div>
                                    <div style="font-weight: bold; color: #0066cc;" id="mc-mean-1">-</div>
                                    <div style="color: #666;">ç†è«–æœŸå¾…å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-mean-1">-</div>
                                    <div style="color: #666;">ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #0066cc;" id="mc-median-1">-</div>
                                    <div style="color: #666;">ç†è«–ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-median-1">-</div>
                                    <div style="color: #666;">ç†è«–æœ€é »å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-mode-1">-</div>
                                    <div style="color: #666;">æœ€å¤§å€¤:</div>
                                    <div style="font-weight: bold; color: #28a745;" id="mc-max-1">-</div>
                                    <div style="color: #666;">æœ€å°å€¤:</div>
                                    <div style="font-weight: bold; color: #dc3545;" id="mc-min-1">-</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px; font-size: 1em;">L=<span id="mc-L-display">3.0</span> ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF (<span id="sim-count-L">100</span>å›ã®çµæœ)</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div style="color: #666;">å¹³å‡å€¤:</div>
                                    <div style="font-weight: bold; color: #ff8c00;" id="mc-mean-L">-</div>
                                    <div style="color: #666;">ç†è«–æœŸå¾…å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-mean-L">-</div>
                                    <div style="color: #666;">ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #ff8c00;" id="mc-median-L">-</div>
                                    <div style="color: #666;">ç†è«–ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-median-L">-</div>
                                    <div style="color: #666;">ç†è«–æœ€é »å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-mode-L">-</div>
                                    <div style="color: #666;">æœ€å¤§å€¤:</div>
                                    <div style="font-weight: bold; color: #28a745;" id="mc-max-L">-</div>
                                    <div style="color: #666;">æœ€å°å€¤:</div>
                                    <div style="font-weight: bold; color: #dc3545;" id="mc-min-L">-</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; font-size: 0.9em;">
                            <strong>ğŸ’¡ ç†è«–å€¤ã®è¦‹æ–¹ï¼š</strong><br>
                            <span style="color: #666;">
                            â€¢ <strong>æœŸå¾…å€¤ï¼ˆç ´ç·šï¼‰</strong>ï¼šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¹³å‡ã«è¿‘ã„ï¼ˆå°‘æ•°ã®å¤§æˆåŠŸãŒå¼•ãä¸Šã’ã‚‹ï¼‰<br>
                            â€¢ <strong>ä¸­å¤®å€¤ï¼ˆå®Ÿç·šï¼‰</strong>ï¼šåŠæ•°ãŒã“ã‚Œã‚ˆã‚Šä¸Šã€åŠæ•°ãŒä¸‹<br>
                            â€¢ <strong>æœ€é »å€¤ï¼ˆç‚¹ç·šï¼‰</strong>ï¼šç¢ºç‡å¯†åº¦ãŒæœ€å¤§ã®ç‚¹ï¼ˆè©¦è¡Œå›æ•°ãŒå¤šã„ã»ã©æ˜ç¢ºã«ãªã‚‹ï¼‰
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š ã‚°ãƒ©ãƒ•4: ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æœ€çµ‚è³‡ç”£åˆ†å¸ƒï¼ˆ<span id="chart4-period">1</span>å¹´å¾Œã€<span id="chart4-simulations">100</span>å›è©¦è¡Œï¼‰</div>
                    <div id="distribution-mc-chart"></div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px; font-size: 1em;">L=1 é€šå¸¸ETF åˆ†å¸ƒçµ±è¨ˆ</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div style="color: #666;">å®Ÿæ¸¬å¹³å‡:</div>
                                    <div style="font-weight: bold; color: #0066cc;" id="dist-mean-1">-</div>
                                    <div style="color: #666;">ç†è«–æœŸå¾…å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="dist-theory-mean-1">-</div>
                                    <div style="color: #666;">å®Ÿæ¸¬ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #0066cc;" id="dist-median-1">-</div>
                                    <div style="color: #666;">ç†è«–ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="dist-theory-median-1">-</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px; font-size: 1em;">L=<span id="dist-L-display">3.0</span> ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF åˆ†å¸ƒçµ±è¨ˆ</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div style="color: #666;">å®Ÿæ¸¬å¹³å‡:</div>
                                    <div style="font-weight: bold; color: #ff8c00;" id="dist-mean-L">-</div>
                                    <div style="color: #666;">ç†è«–æœŸå¾…å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="dist-theory-mean-L">-</div>
                                    <div style="color: #666;">å®Ÿæ¸¬ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #ff8c00;" id="dist-median-L">-</div>
                                    <div style="color: #666;">ç†è«–ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="dist-theory-median-L">-</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 4px solid #0066cc; border-radius: 5px; font-size: 0.9em;">
                            <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong><br>
                            <span style="color: #666;">
                            è©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™ã»ã©ã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãŒç†è«–åˆ†å¸ƒæ›²ç·šï¼ˆå®Ÿç·šï¼‰ã«è¿‘ã¥ãã¾ã™ã€‚<br>
                            10,000å›ã§å®Ÿæ¸¬å€¤ã¨ç†è«–å€¤ãŒã»ã¼ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•°å­¦é–¢æ•°
        function lognormalPDF(x, alpha, beta) {
            if (x <= 0 || beta <= 0) return 0;
            return (1 / (x * beta * Math.sqrt(2 * Math.PI))) * 
                   Math.exp(-Math.pow(Math.log(x) - alpha, 2) / (2 * beta * beta));
        }
        
        function lognormalMedian(alpha, initialValue = 1) {
            return initialValue * Math.exp(alpha);
        }
        
        function lognormalMean(alpha, beta, initialValue = 1) {
            return initialValue * Math.exp(alpha + beta * beta / 2);
        }
        
        function lognormalMode(alpha, beta, initialValue = 1) {
            return initialValue * Math.exp(alpha - beta * beta);
        }
        
        function getParams(L, mu, sigma, b, c, T) {
            const sigma2 = sigma * sigma;
            // Tå¹´å¾Œã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆæ—¥æ¬¡ãƒªãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ‡ãƒ«ã®ç†è«–å€¤ï¼‰
            // log(S_T / S_0) ~ N(alpha, beta^2)
            // æ—¥æ¬¡ãƒªãƒãƒ©ãƒ³ã‚¹: æ¯æ—¥ L*r_t ã‚’ä¹—ã˜ãŸçµæœã®ç´¯ç©åˆ†å¸ƒ
            // alpha = T * [L*Î¼ - (L-1)*b - c - 0.5*LÂ²*ÏƒÂ²] (æœŸå¾…å¯¾æ•°ãƒªã‚¿ãƒ¼ãƒ³)
            // beta = sqrt(T) * L * Ïƒ (ç´¯ç©ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£)
            const alpha = T * (L * mu - (L - 1) * b - c - 0.5 * L * L * sigma2);
            const beta = Math.sqrt(T) * L * sigma;
            return { alpha, beta };
        }
        
        // Box-Mulleræ³•ã§æ­£è¦ä¹±æ•°ã‚’ç”Ÿæˆ
        function randomNormal() {
            const u1 = Math.random();
            const u2 = Math.random();
            return Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
        }
        
        // æ—¥æ¬¡ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æ¬¡ãƒªãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼‰
        function runDailyMonteCarloSimulation(L, mu, sigma, b, c, T, numSimulations = 100, initialValue = 100) {
            const tradingDaysPerYear = 252; // ç±³å›½å¸‚å ´ã®å¹³å‡å–¶æ¥­æ—¥æ•°
            const totalDays = T * tradingDaysPerYear;
            const dt = 1 / tradingDaysPerYear; // 1æ—¥ = 1/252å¹´
            const EPS = 1e-10; // ã‚¼ãƒ­å‰²ã‚Œé˜²æ­¢
            
            const trajectories = [];
            
            for (let sim = 0; sim < numSimulations; sim++) {
                const trajectory = [initialValue]; // åˆæœŸå€¤
                let currentValue = initialValue;
                
                for (let day = 1; day <= totalDays; day++) {
                    // åŸæŒ‡æ•°ï¼ˆSOXç›¸å½“ï¼‰ã®æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
                    // r_t ~ N((Î¼ - 0.5ÏƒÂ²)dt, Ïƒâˆšdt)
                    const dW = randomNormal();
                    const indexReturn = (mu - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * dW;
                    
                    // ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã®æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ = L * åŸæŒ‡æ•°ãƒªã‚¿ãƒ¼ãƒ³
                    const leveragedReturn = L * indexReturn;
                    
                    // æ—¥æ¬¡ãƒªãƒãƒ©ãƒ³ã‚¹å¾Œã®ä¾¡æ ¼
                    // S_{t+dt} = S_t * exp(L * r_t - (L-1)*b*dt - c*dt)
                    const costFactor = Math.exp(-(L - 1) * b * dt - c * dt);
                    currentValue = Math.max(EPS, currentValue * Math.exp(leveragedReturn) * costFactor);
                    
                    trajectory.push(currentValue);
                }
                
                trajectories.push(trajectory);
            }
            
            return trajectories;
        }
        
        // æœ€çµ‚å€¤ã‚’å–å¾—
        function getFinalValues(trajectories) {
            return trajectories.map(traj => traj[traj.length - 1]);
        }
        
        // çµ±è¨ˆé‡è¨ˆç®—
        function calculateStats(data) {
            const sorted = [...data].sort((a, b) => a - b);
            const mean = data.reduce((a, b) => a + b, 0) / data.length;
            const median = sorted[Math.floor(sorted.length / 2)];
            const min = Math.min(...data);
            const max = Math.max(...data);
            
            return { mean, median, min, max };
        }
        
        function updateCharts() {
            const T = parseInt(document.getElementById('T').value);
            const L = parseFloat(document.getElementById('L').value);
            const mu = parseFloat(document.getElementById('mu').value);
            const sigma = parseFloat(document.getElementById('sigma').value);
            const b = parseFloat(document.getElementById('b').value);
            const c = parseFloat(document.getElementById('c').value);
            const numSimulations = parseInt(document.getElementById('simulations').value);
            const yMax = parseInt(document.getElementById('ymax').value);
            
            // Yè»¸æœ€å¤§å€¤ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
            window.linearYMax = yMax;
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¡¨ç¤ºæ›´æ–°
            document.getElementById('T-value').textContent = T;
            document.getElementById('L-value').textContent = L.toFixed(1);
            document.getElementById('mu-value').textContent = mu.toFixed(2);
            document.getElementById('sigma-value').textContent = sigma.toFixed(2);
            document.getElementById('b-value').textContent = b.toFixed(3);
            document.getElementById('c-value').textContent = c.toFixed(4);
            document.getElementById('simulations-value').textContent = numSimulations;
            document.getElementById('ymax-value').textContent = yMax;
            document.getElementById('period-display').textContent = T + 'å¹´';
            document.getElementById('chart1-period').textContent = T;
            
            // çµ±è¨ˆé‡è¨ˆç®—ï¼ˆæœŸé–“ã«ä¾å­˜ã—ãªã„ï¼‰
            const riskPremium = mu - b;
            const sigma2 = sigma * sigma;
            const medianLimit = (2 * riskPremium / sigma2) - 1;
            const modeLimit = (2 * riskPremium / (3 * sigma2)) - 1;
            
            document.getElementById('risk-premium').textContent = riskPremium.toFixed(3);
            document.getElementById('median-limit').textContent = 'L = ' + medianLimit.toFixed(2);
            document.getElementById('mode-limit').textContent = 'L = ' + modeLimit.toFixed(2);
            
            // L=1ã¨L=Lã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’Tå¹´ã§è¨ˆç®—
            const params1 = getParams(1, mu, sigma, b, c, T);
            const paramsL = getParams(L, mu, sigma, b, c, T);
            
            // Xè»¸ã®ç¯„å›²ã‚’æŠ•è³‡æœŸé–“ã«å¿œã˜ã¦èª¿æ•´
            const xMax = Math.min(Math.max(10, T * 2), 50);
            
            // åˆ†å¸ƒã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const x = [];
            const pdf1 = [];
            const pdfL = [];
            
            for (let i = 0.01; i <= xMax; i += xMax/1000) {
                x.push(i);
                pdf1.push(lognormalPDF(i, params1.alpha, params1.beta));
                pdfL.push(lognormalPDF(i, paramsL.alpha, paramsL.beta));
            }
            
            const mean1 = lognormalMean(params1.alpha, params1.beta);
            const median1 = lognormalMedian(params1.alpha);
            const mode1 = lognormalMode(params1.alpha, params1.beta);
            
            const meanL = lognormalMean(paramsL.alpha, paramsL.beta);
            const medianL = lognormalMedian(paramsL.alpha);
            const modeL = lognormalMode(paramsL.alpha, paramsL.beta);
            
            // æ¯”ç‡ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
            const meanRatio = meanL / mean1;
            const medianRatio = medianL / median1;
            const modeRatio = modeL / mode1;
            
            document.getElementById('mean-ratio').textContent = meanRatio.toFixed(3) + 'x';
            document.getElementById('mean-ratio').style.color = meanRatio >= 1 ? '#28a745' : '#dc3545';
            
            document.getElementById('median-ratio').textContent = medianRatio.toFixed(3) + 'x';
            document.getElementById('median-ratio').style.color = medianRatio >= 1 ? '#28a745' : '#dc3545';
            
            document.getElementById('mode-ratio').textContent = modeRatio.toFixed(3) + 'x';
            document.getElementById('mode-ratio').style.color = modeRatio >= 1 ? '#28a745' : '#dc3545';
            
            // åˆ†å¸ƒã‚°ãƒ©ãƒ•æç”»
            const distributionData = [
                {
                    x: x,
                    y: pdf1,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'L=1 é€šå¸¸ETF',
                    line: { color: 'blue', width: 3 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(0,0,255,0.1)'
                },
                {
                    x: x,
                    y: pdfL,
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF`,
                    line: { color: 'darkorange', width: 3 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(255,140,0,0.1)'
                },
                {
                    x: [mean1, mean1],
                    y: [0, Math.max(...pdf1) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=1 æœŸå¾…å€¤: ${mean1.toFixed(2)}`,
                    line: { color: 'blue', dash: 'dot', width: 2 }
                },
                {
                    x: [median1, median1],
                    y: [0, Math.max(...pdf1) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=1 ä¸­å¤®å€¤: ${median1.toFixed(2)}`,
                    line: { color: 'blue', dash: 'dash', width: 2 }
                },
                {
                    x: [mode1, mode1],
                    y: [0, Math.max(...pdf1) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=1 æœ€é »å€¤: ${mode1.toFixed(2)}`,
                    line: { color: 'blue', dash: 'dashdot', width: 2 }
                },
                {
                    x: [meanL, meanL],
                    y: [0, Math.max(...pdfL) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} æœŸå¾…å€¤: ${meanL.toFixed(2)}`,
                    line: { color: 'darkorange', dash: 'dot', width: 2 }
                },
                {
                    x: [medianL, medianL],
                    y: [0, Math.max(...pdfL) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} ä¸­å¤®å€¤: ${medianL.toFixed(2)}`,
                    line: { color: 'darkorange', dash: 'dash', width: 2 }
                },
                {
                    x: [modeL, modeL],
                    y: [0, Math.max(...pdfL) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} æœ€é »å€¤: ${modeL.toFixed(2)}`,
                    line: { color: 'darkorange', dash: 'dashdot', width: 2 }
                }
            ];
            
            const distributionLayout = {
                xaxis: { 
                    title: `${T}å¹´å¾Œã®è³‡ç”£å€ç‡ (å…ƒæœ¬=1)`, 
                    range: [0, xMax]
                },
                yaxis: { title: 'ç¢ºç‡å¯†åº¦' },
                showlegend: true,
                legend: { x: 0.65, y: 1, font: { size: 9 } },
                margin: { l: 60, r: 20, t: 20, b: 60 },
                height: 450
            };
            
            Plotly.newPlot('distribution-chart', distributionData, distributionLayout, {responsive: true});
            
            // å„ªä½ã‚¾ãƒ¼ãƒ³ã‚°ãƒ©ãƒ•
            const zonesData = [];
            
            // æœŸå¾…å€¤ã‚¾ãƒ¼ãƒ³
            if (mu > b) {
                zonesData.push({
                    x: [1, 5, 5, 1],
                    y: [2.67, 2.67, 3, 3],
                    fill: 'toself',
                    fillcolor: 'rgba(0,255,0,0.3)',
                    line: { width: 0 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
            
            // ä¸­å¤®å€¤ã‚¾ãƒ¼ãƒ³
            if (medianLimit > 1) {
                const medianEnd = Math.min(medianLimit, 5);
                zonesData.push({
                    x: [1, medianEnd, medianEnd, 1],
                    y: [1.33, 1.33, 2, 2],
                    fill: 'toself',
                    fillcolor: 'rgba(0,255,0,0.3)',
                    line: { width: 0 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
                
                if (medianLimit < 5) {
                    zonesData.push({
                        x: [medianLimit, 5, 5, medianLimit],
                        y: [1.33, 1.33, 2, 2],
                        fill: 'toself',
                        fillcolor: 'rgba(255,0,0,0.3)',
                        line: { width: 0 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });
                    zonesData.push({
                        x: [medianLimit, medianLimit],
                        y: [1.33, 2],
                        type: 'scatter',
                        mode: 'lines',
                        name: `ä¸­å¤®å€¤ä¸Šé™ L=${medianLimit.toFixed(2)}`,
                        line: { color: 'blue', dash: 'dash', width: 2 }
                    });
                }
            } else {
                zonesData.push({
                    x: [1, 5, 5, 1],
                    y: [1.33, 1.33, 2, 2],
                    fill: 'toself',
                    fillcolor: 'rgba(255,0,0,0.3)',
                    line: { width: 0 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
            
            // æœ€é »å€¤ã‚¾ãƒ¼ãƒ³
            if (modeLimit > 1) {
                const modeEnd = Math.min(modeLimit, 5);
                zonesData.push({
                    x: [1, modeEnd, modeEnd, 1],
                    y: [0, 0, 0.67, 0.67],
                    fill: 'toself',
                    fillcolor: 'rgba(0,255,0,0.3)',
                    line: { width: 0 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
                
                if (modeLimit < 5) {
                    zonesData.push({
                        x: [modeLimit, 5, 5, modeLimit],
                        y: [0, 0, 0.67, 0.67],
                        fill: 'toself',
                        fillcolor: 'rgba(255,0,0,0.3)',
                        line: { width: 0 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });
                    zonesData.push({
                        x: [modeLimit, modeLimit],
                        y: [0, 0.67],
                        type: 'scatter',
                        mode: 'lines',
                        name: `æœ€é »å€¤ä¸Šé™ L=${modeLimit.toFixed(2)}`,
                        line: { color: 'purple', dash: 'dash', width: 2 }
                    });
                }
            } else {
                zonesData.push({
                    x: [1, 5, 5, 1],
                    y: [0, 0, 0.67, 0.67],
                    fill: 'toself',
                    fillcolor: 'rgba(255,0,0,0.3)',
                    line: { width: 0 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
            
            // ç¾åœ¨ã®Lä½ç½®
            zonesData.push({
                x: [L, L],
                y: [0, 3],
                type: 'scatter',
                mode: 'lines',
                name: `ç¾åœ¨é¸æŠä¸­ L=${L}`,
                line: { color: 'black', width: 3 }
            });
            
            const zonesLayout = {
                xaxis: { title: 'ãƒ¬ãƒãƒ¬ãƒƒã‚¸å€ç‡ (L)', range: [1, 5] },
                yaxis: { 
                    tickvals: [0.335, 1.665, 2.5],
                    ticktext: ['æœ€é »å€¤ (Mode)', 'ä¸­å¤®å€¤ (Median)', 'æœŸå¾…å€¤ (Mean)'],
                    range: [0, 3]
                },
                showlegend: true,
                legend: { x: 0.6, y: 1 },
                margin: { l: 100, r: 20, t: 20, b: 60 },
                height: 300
            };
            
            Plotly.newPlot('zones-chart', zonesData, zonesLayout, {responsive: true});
            
            // ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æ¬¡ï¼‰
            document.getElementById('chart3-period').textContent = T;
            document.getElementById('chart3-simulations').textContent = numSimulations;
            document.getElementById('sim-count-1').textContent = numSimulations;
            document.getElementById('sim-count-L').textContent = numSimulations;
            document.getElementById('mc-L-display').textContent = L.toFixed(1);
            
            const tradingDaysPerYear = 252; // ç±³å›½å¸‚å ´ã®å¹³å‡å–¶æ¥­æ—¥æ•°ã«çµ±ä¸€
            const totalDays = T * tradingDaysPerYear;
            
            const initialValue = 100; // åˆæœŸæŠ•è³‡é¡: 100ä¸‡å††
            
            // æ—¥æ¬¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆå‹•çš„ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°ï¼‰
            const trajectories1 = runDailyMonteCarloSimulation(1, mu, sigma, b, c, T, numSimulations, initialValue);
            const trajectoriesL = runDailyMonteCarloSimulation(L, mu, sigma, b, c, T, numSimulations, initialValue);
            
            // æœ€çµ‚å€¤ã®çµ±è¨ˆ
            const finalValues1 = getFinalValues(trajectories1);
            const finalValuesL = getFinalValues(trajectoriesL);
            
            const stats1 = calculateStats(finalValues1);
            const statsL = calculateStats(finalValuesL);
            
            // ç†è«–å€¤ã‚’è¨ˆç®—
            const params1_final = getParams(1, mu, sigma, b, c, T);
            const paramsL_final = getParams(L, mu, sigma, b, c, T);
            
            const theoryMean1 = lognormalMean(params1_final.alpha, params1_final.beta, initialValue);
            const theoryMedian1 = lognormalMedian(params1_final.alpha, initialValue);
            const theoryMode1 = lognormalMode(params1_final.alpha, params1_final.beta, initialValue);
            const theoryMeanL = lognormalMean(paramsL_final.alpha, paramsL_final.beta, initialValue);
            const theoryMedianL = lognormalMedian(paramsL_final.alpha, initialValue);
            const theoryModeL = lognormalMode(paramsL_final.alpha, paramsL_final.beta, initialValue);
            
            // çµ±è¨ˆé‡è¡¨ç¤ºï¼ˆä¸‡å††å˜ä½ï¼‰
            document.getElementById('mc-mean-1').textContent = stats1.mean.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-mean-1').textContent = theoryMean1.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-median-1').textContent = stats1.median.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-median-1').textContent = theoryMedian1.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-mode-1').textContent = theoryMode1.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-max-1').textContent = stats1.max.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-min-1').textContent = stats1.min.toFixed(1) + 'ä¸‡å††';
            
            document.getElementById('mc-mean-L').textContent = statsL.mean.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-mean-L').textContent = theoryMeanL.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-median-L').textContent = statsL.median.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-median-L').textContent = theoryMedianL.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-mode-L').textContent = theoryModeL.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-max-L').textContent = statsL.max.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-min-L').textContent = statsL.min.toFixed(1) + 'ä¸‡å††';
            
            // ã‚°ãƒ©ãƒ•ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆè¡¨ç¤ºç”¨ã«é–“å¼•ãï¼‰
            const samplingInterval = Math.max(1, Math.floor(totalDays / 500)); // æœ€å¤§500ãƒã‚¤ãƒ³ãƒˆ
            const montecarloData = [];
            
            // L=1ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è»Œè·¡ï¼ˆã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰
            // å¤šã™ãã‚‹å ´åˆã¯é€æ˜åº¦ã‚’ä¸Šã’ã‚‹
            const lineOpacity = numSimulations <= 100 ? 0.15 : Math.max(0.02, 15 / numSimulations);
            
            for (let i = 0; i < numSimulations; i++) {
                const sampledX = [];
                const sampledY = [];
                for (let d = 0; d <= totalDays; d += samplingInterval) {
                    const index = Math.min(Math.floor(d), trajectories1[i].length - 1);
                    sampledX.push(d / tradingDaysPerYear); // å¹´å˜ä½ã«å¤‰æ›
                    sampledY.push(trajectories1[i][index]);
                }
                montecarloData.push({
                    x: sampledX,
                    y: sampledY,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: `rgba(0, 0, 255, ${lineOpacity})`, width: 1 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
            
            // L=Lã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è»Œè·¡ï¼ˆã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰
            for (let i = 0; i < numSimulations; i++) {
                const sampledX = [];
                const sampledY = [];
                for (let d = 0; d <= totalDays; d += samplingInterval) {
                    const index = Math.min(Math.floor(d), trajectoriesL[i].length - 1);
                    sampledX.push(d / tradingDaysPerYear); // å¹´å˜ä½ã«å¤‰æ›
                    sampledY.push(trajectoriesL[i][index]);
                }
                montecarloData.push({
                    x: sampledX,
                    y: sampledY,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: `rgba(255, 140, 0, ${lineOpacity})`, width: 1 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
            
            // ç†è«–å€¤ã®è»Œè·¡ï¼ˆå¹´å˜ä½ï¼‰
            const yearPoints = [];
            const expectedPath1 = [];
            const expectedPathL = [];
            const medianPath1 = [];
            const medianPathL = [];
            const modePath1 = [];
            const modePathL = [];
            
            for (let y = 0; y <= T; y += 0.1) {
                yearPoints.push(y);
                if (y === 0) {
                    expectedPath1.push(initialValue);
                    expectedPathL.push(initialValue);
                    medianPath1.push(initialValue);
                    medianPathL.push(initialValue);
                    modePath1.push(initialValue);
                    modePathL.push(initialValue);
                } else {
                    const p1 = getParams(1, mu, sigma, b, c, y);
                    const pL = getParams(L, mu, sigma, b, c, y);
                    expectedPath1.push(lognormalMean(p1.alpha, p1.beta, initialValue));
                    expectedPathL.push(lognormalMean(pL.alpha, pL.beta, initialValue));
                    medianPath1.push(lognormalMedian(p1.alpha, initialValue));
                    medianPathL.push(lognormalMedian(pL.alpha, initialValue));
                    modePath1.push(lognormalMode(p1.alpha, p1.beta, initialValue));
                    modePathL.push(lognormalMode(pL.alpha, pL.beta, initialValue));
                }
            }
            
            // ç†è«–æœŸå¾…å€¤ï¼ˆç ´ç·šï¼‰
            montecarloData.push({
                x: yearPoints,
                y: expectedPath1,
                type: 'scatter',
                mode: 'lines',
                name: 'L=1 ç†è«–æœŸå¾…å€¤',
                line: { color: 'blue', width: 3, dash: 'dash' }
            });
            
            montecarloData.push({
                x: yearPoints,
                y: expectedPathL,
                type: 'scatter',
                mode: 'lines',
                name: `L=${L} ç†è«–æœŸå¾…å€¤`,
                line: { color: 'darkorange', width: 3, dash: 'dash' }
            });
            
            // ç†è«–ä¸­å¤®å€¤ï¼ˆå®Ÿç·šãƒ»ç´°ã‚ï¼‰
            montecarloData.push({
                x: yearPoints,
                y: medianPath1,
                type: 'scatter',
                mode: 'lines',
                name: 'L=1 ç†è«–ä¸­å¤®å€¤',
                line: { color: 'blue', width: 2, dash: 'solid' }
            });
            
            montecarloData.push({
                x: yearPoints,
                y: medianPathL,
                type: 'scatter',
                mode: 'lines',
                name: `L=${L} ç†è«–ä¸­å¤®å€¤`,
                line: { color: 'darkorange', width: 2, dash: 'solid' }
            });
            
            // ç†è«–æœ€é »å€¤ï¼ˆç‚¹ç·šï¼‰
            montecarloData.push({
                x: yearPoints,
                y: modePath1,
                type: 'scatter',
                mode: 'lines',
                name: 'L=1 ç†è«–æœ€é »å€¤',
                line: { color: 'blue', width: 3, dash: 'dot' }
            });
            
            montecarloData.push({
                x: yearPoints,
                y: modePathL,
                type: 'scatter',
                mode: 'lines',
                name: `L=${L} ç†è«–æœ€é »å€¤`,
                line: { color: 'darkorange', width: 3, dash: 'dot' }
            });
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿å­˜ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰
            window.montecarloData = montecarloData;
            window.montecarloT = T;
            
            const yAxisConfig = window.isLogScale !== false 
                ? { title: 'è³‡ç”£é¡ (ä¸‡å††)', type: 'log' }
                : { title: 'è³‡ç”£é¡ (ä¸‡å††)', type: 'linear', range: [0, window.linearYMax || 1000] };
            
            const montecarloLayout = {
                xaxis: { title: 'æŠ•è³‡å¹´æ•°', range: [0, T] },
                yaxis: yAxisConfig,
                showlegend: true,
                legend: { x: 0.02, y: 0.98 },
                margin: { l: 60, r: 20, t: 20, b: 60 },
                height: 500
            };
            
            Plotly.newPlot('montecarlo-chart', montecarloData, montecarloLayout, {responsive: true});
            
            // ã‚°ãƒ©ãƒ•4: ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æœ€çµ‚è³‡ç”£åˆ†å¸ƒ
            document.getElementById('chart4-period').textContent = T;
            document.getElementById('chart4-simulations').textContent = numSimulations;
            document.getElementById('dist-L-display').textContent = L.toFixed(1);
            
            // å€ç‡ã«å¤‰æ›ï¼ˆå…ƒæœ¬=100ä¸‡å†† â†’ å€ç‡ï¼‰
            const finalRatios1 = finalValues1.map(v => v / initialValue);
            const finalRatiosL = finalValuesL.map(v => v / initialValue);
            
            const statsRatio1 = calculateStats(finalRatios1);
            const statsRatioL = calculateStats(finalRatiosL);
            
            // ç†è«–å€¤ã‚‚å€ç‡ã§
            const theoryMeanRatio1 = theoryMean1 / initialValue;
            const theoryMedianRatio1 = theoryMedian1 / initialValue;
            const theoryMeanRatioL = theoryMeanL / initialValue;
            const theoryMedianRatioL = theoryMedianL / initialValue;
            
            // çµ±è¨ˆé‡è¡¨ç¤ºï¼ˆå€ç‡ï¼‰
            document.getElementById('dist-mean-1').textContent = statsRatio1.mean.toFixed(3) + 'x';
            document.getElementById('dist-theory-mean-1').textContent = theoryMeanRatio1.toFixed(3) + 'x';
            document.getElementById('dist-median-1').textContent = statsRatio1.median.toFixed(3) + 'x';
            document.getElementById('dist-theory-median-1').textContent = theoryMedianRatio1.toFixed(3) + 'x';
            
            document.getElementById('dist-mean-L').textContent = statsRatioL.mean.toFixed(3) + 'x';
            document.getElementById('dist-theory-mean-L').textContent = theoryMeanRatioL.toFixed(3) + 'x';
            document.getElementById('dist-median-L').textContent = statsRatioL.median.toFixed(3) + 'x';
            document.getElementById('dist-theory-median-L').textContent = theoryMedianRatioL.toFixed(3) + 'x';
            
            // ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ç”¨ã®ãƒ“ãƒ³æ•°ã‚’è¨ˆç®—ï¼ˆSturgesã®å…¬å¼ï¼‰
            const numBins = Math.ceil(Math.log2(numSimulations) + 1);
            
            // ã‚°ãƒ©ãƒ•1ã¨åŒã˜Xè»¸ç¯„å›²ã‚’ä½¿ç”¨
            const xMaxMC = Math.min(Math.max(10, T * 2), 50);
            
            // ç†è«–åˆ†å¸ƒæ›²ç·šã®ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå€ç‡ãƒ™ãƒ¼ã‚¹ï¼‰
            const theoryCurveX1 = [];
            const theoryCurveY1 = [];
            const theoryCurveXL = [];
            const theoryCurveYL = [];
            
            for (let ratio = 0.01; ratio <= xMaxMC; ratio += xMaxMC / 1000) {
                theoryCurveX1.push(ratio);
                theoryCurveY1.push(lognormalPDF(ratio, params1_final.alpha, params1_final.beta));
                theoryCurveXL.push(ratio);
                theoryCurveYL.push(lognormalPDF(ratio, paramsL_final.alpha, paramsL_final.beta));
            }
            
            const distributionMCData = [
                // L=1 ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
                {
                    x: finalRatios1,
                    type: 'histogram',
                    name: 'L=1 å®Ÿæ¸¬åˆ†å¸ƒ',
                    marker: { color: 'rgba(0, 0, 255, 0.6)' },
                    nbinsx: numBins,
                    histnorm: 'probability density'
                },
                // L=L ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
                {
                    x: finalRatiosL,
                    type: 'histogram',
                    name: `L=${L} å®Ÿæ¸¬åˆ†å¸ƒ`,
                    marker: { color: 'rgba(255, 140, 0, 0.6)' },
                    nbinsx: numBins,
                    histnorm: 'probability density'
                },
                // L=1 ç†è«–æ›²ç·š
                {
                    x: theoryCurveX1,
                    y: theoryCurveY1,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'L=1 ç†è«–åˆ†å¸ƒ',
                    line: { color: 'blue', width: 3 }
                },
                // L=L ç†è«–æ›²ç·š
                {
                    x: theoryCurveXL,
                    y: theoryCurveYL,
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} ç†è«–åˆ†å¸ƒ`,
                    line: { color: 'darkorange', width: 3 }
                },
                // L=1 ç†è«–æœŸå¾…å€¤
                {
                    x: [theoryMeanRatio1, theoryMeanRatio1],
                    y: [0, Math.max(...theoryCurveY1) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=1 æœŸå¾…å€¤: ${theoryMeanRatio1.toFixed(2)}`,
                    line: { color: 'blue', dash: 'dot', width: 2 }
                },
                // L=1 ç†è«–ä¸­å¤®å€¤
                {
                    x: [theoryMedianRatio1, theoryMedianRatio1],
                    y: [0, Math.max(...theoryCurveY1) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=1 ä¸­å¤®å€¤: ${theoryMedianRatio1.toFixed(2)}`,
                    line: { color: 'blue', dash: 'dash', width: 2 }
                },
                // L=L ç†è«–æœŸå¾…å€¤
                {
                    x: [theoryMeanRatioL, theoryMeanRatioL],
                    y: [0, Math.max(...theoryCurveYL) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} æœŸå¾…å€¤: ${theoryMeanRatioL.toFixed(2)}`,
                    line: { color: 'darkorange', dash: 'dot', width: 2 }
                },
                // L=L ç†è«–ä¸­å¤®å€¤
                {
                    x: [theoryMedianRatioL, theoryMedianRatioL],
                    y: [0, Math.max(...theoryCurveYL) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} ä¸­å¤®å€¤: ${theoryMedianRatioL.toFixed(2)}`,
                    line: { color: 'darkorange', dash: 'dash', width: 2 }
                }
            ];
            
            const distributionMCLayout = {
                xaxis: { 
                    title: `${T}å¹´å¾Œã®è³‡ç”£å€ç‡ (å…ƒæœ¬=1)`,
                    range: [0, xMaxMC]
                },
                yaxis: { title: 'ç¢ºç‡å¯†åº¦' },
                barmode: 'overlay',
                showlegend: true,
                legend: { x: 0.65, y: 1, font: { size: 9 } },
                margin: { l: 60, r: 20, t: 20, b: 60 },
                height: 450
            };
            
            Plotly.newPlot('distribution-mc-chart', distributionMCData, distributionMCLayout, {responsive: true});
        }
        
        // ã‚¹ã‚±ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        window.isLogScale = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«
        
        document.getElementById('toggle-log-scale').addEventListener('click', function() {
            window.isLogScale = !window.isLogScale;
            
            const button = document.getElementById('toggle-log-scale');
            button.textContent = window.isLogScale ? 'ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆ‡æ›¿' : 'å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆ‡æ›¿';
            
            if (window.montecarloData) {
                const yAxisConfig = window.isLogScale 
                    ? { title: 'è³‡ç”£é¡ (ä¸‡å††)', type: 'log' }
                    : { title: 'è³‡ç”£é¡ (ä¸‡å††)', type: 'linear', range: [0, window.linearYMax || 1000] };
                
                const layout = {
                    xaxis: { title: 'æŠ•è³‡å¹´æ•°', range: [0, window.montecarloT] },
                    yaxis: yAxisConfig,
                    showlegend: true,
                    legend: { x: 0.02, y: 0.98 },
                    margin: { l: 60, r: 20, t: 20, b: 60 },
                    height: 500
                };
                
                Plotly.newPlot('montecarlo-chart', window.montecarloData, layout, {responsive: true});
            }
        });
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const inputs = ['T', 'L', 'mu', 'sigma', 'b', 'c', 'simulations', 'ymax'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', updateCharts);
        });
        
        // åˆæœŸæç”»
        updateCharts();
        
        // MathJaxã®æ•°å¼ã‚’è¡¨ç¤º
        function renderFormula() {
            const formulaDiv = document.getElementById('formula-display');
            formulaDiv.innerHTML = '\\[\\approx R^L \\times e^{-\\frac{1}{2}L(L-1)\\sigma^2} \\times e^{-(L-1)b} \\times e^{-c}\\]';
            
            document.getElementById('label-1').innerHTML = '\\(R^L\\)';
            document.getElementById('label-2').innerHTML = '\\(e^{-\\frac{1}{2}L(L-1)\\sigma^2}\\)';
            document.getElementById('label-3').innerHTML = '\\(e^{-(L-1)b}\\)';
            document.getElementById('label-4').innerHTML = '\\(e^{-c}\\)';
            
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ•°å¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        window.addEventListener('load', renderFormula);
    </script>
</body>
</html>
