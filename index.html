<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 0;
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #dee2e6;
            max-height: 1200px;
            overflow-y: auto;
        }
        
        .main {
            padding: 30px;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .control-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .value-display {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .value-display.highlight {
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card h3 {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 1.6em;
            font-weight: 700;
        }
        
        .section-divider {
            margin: 20px 0;
            border-top: 2px solid #dee2e6;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .info-box h4 {
            color: #0066cc;
            margin-bottom: 8px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .warning-box h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        #run-simulation:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        #run-simulation:active {
            transform: translateY(0);
        }
        
        #run-simulation:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #toggle-dist-x-scale:hover,
        #toggle-dist-y-scale:hover {
            background: #764ba2;
            transform: translateY(-1px);
        }
        
        #toggle-dist-x-scale:active,
        #toggle-dist-y-scale:active {
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p>å¯¾æ•°æ­£è¦åˆ†å¸ƒãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹è³‡ç”£åˆ†å¸ƒã¨ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>
            <p style="font-size: 0.9em; opacity: 0.9; margin-top: 8px;">
                ğŸ’¡ åˆæœŸå€¤ã¯SOXLï¼ˆåŠå°ä½“3å€ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFï¼‰ã«åˆã‚ã›ã¦è¨­å®šã—ã¦ã„ã¾ã™
            </p>
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.95em;">
                <strong>ğŸ’° Lå€ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã®è¤‡åˆ©è¾¼ã¿å¹³å‡å¹´åˆ©ï¼ˆå€ï¼‰ã®åŸå‰‡</strong><br>
                <div id="formula-display" style="margin-top: 15px; font-size: 1.3em; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 5px; text-align: center;">
                    <!-- MathJax formula will be rendered here -->
                </div>
                <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; font-size: 0.9em;">
                    <div>â‘ å¢—ä¾¡<br><span id="label-1"></span></div>
                    <div>â‘¡æ¸›ä¾¡<br><span id="label-2"></span></div>
                    <div>â‘¢é‡‘åˆ©<br><span id="label-3"></span></div>
                    <div>â‘£çµŒè²»<br><span id="label-4"></span></div>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <h2 style="margin-bottom: 20px; color: #667eea;">âš™ï¸ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š</h2>
                
                <div class="control-group">
                    <label>â±ï¸ æŠ•è³‡æœŸé–“ (Tå¹´) <span class="value-display highlight" id="T-value">1</span></label>
                    <input type="range" id="T" min="1" max="20" step="1" value="1">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        æœŸé–“ãŒé•·ã„ã»ã©åˆ†å¸ƒãŒåºƒãŒã‚Šã¾ã™
                    </small>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>ãƒ¬ãƒãƒ¬ãƒƒã‚¸ (L) <span class="value-display" id="L-value">3.0</span></label>
                    <input type="range" id="L" min="1" max="5" step="0.1" value="3.0">
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>ãƒ‰ãƒªãƒ•ãƒˆ (Î¼) <span class="value-display" id="mu-value">0.14</span></label>
                    <input type="range" id="mu" min="0" max="0.3" step="0.01" value="0.14">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        å¹´é–“æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³ç‡
                    </small>
                </div>
                
                <div class="control-group">
                    <label>ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ (Ïƒ) <span class="value-display" id="sigma-value">0.34</span></label>
                    <input type="range" id="sigma" min="0.01" max="0.5" step="0.01" value="0.34">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        å¹´é–“å¤‰å‹•ç‡
                    </small>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>é‡‘åˆ© (b) <span class="value-display" id="b-value">0.030</span></label>
                    <input type="range" id="b" min="0" max="0.1" step="0.005" value="0.03">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã‚³ã‚¹ãƒˆ
                    </small>
                </div>
                
                <div class="control-group">
                    <label>çµŒè²» (c) <span class="value-display" id="c-value">0.0095</span></label>
                    <input type="range" id="c" min="0" max="0.1" step="0.0005" value="0.0095">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        å¹´é–“é‹ç”¨çµŒè²»ç‡
                    </small>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>ğŸ² ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•° <span class="value-display highlight" id="simulations-value">100</span></label>
                    <input type="range" id="simulations" min="1" max="5000" step="1" value="100">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã®è©¦è¡Œå›æ•°ï¼ˆ1ã€œ5,000å›ã€å¤šã„ã»ã©ç²¾åº¦å‘ä¸Šï¼‰
                    </small>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <button id="run-simulation" style="
                        width: 100%;
                        padding: 15px;
                        font-size: 1.1em;
                        font-weight: bold;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        transition: all 0.3s;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    ">
                        ğŸš€ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                    </button>
                    <div id="loading" style="
                        display: none;
                        text-align: center;
                        margin-top: 15px;
                        padding: 10px;
                        background: #f8f9fa;
                        border-radius: 5px;
                        color: #667eea;
                        font-weight: bold;
                    ">
                        â³ è¨ˆç®—ä¸­...
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="control-group">
                    <label>ğŸ“ ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«Yè»¸æœ€å¤§å€¤ <span class="value-display" id="ymax-value">1000</span></label>
                    <input type="range" id="ymax" min="100" max="5000" step="100" value="1000">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã®ã‚°ãƒ©ãƒ•3ã®Yè»¸ä¸Šé™ï¼ˆä¸‡å††ï¼‰
                    </small>
                </div>
                
                <div class="info-box" style="margin-top: 30px;">
                    <h4>ğŸ’¡ æŠ•è³‡æœŸé–“ã®å½±éŸ¿</h4>
                    <p style="font-size: 0.9em;">
                        æœŸé–“ãŒé•·ã„ã»ã©ï¼š<br>
                        â€¢ åˆ†å¸ƒãŒæ¨ªã«åºƒãŒã‚‹<br>
                        â€¢ æœŸå¾…å€¤ã¨æœ€é »å€¤ã®ä¹–é›¢ãŒæ‹¡å¤§<br>
                        â€¢ ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æ¸›ä¾¡ãŒé¡•è‘—ã«
                    </p>
                </div>
                
                <div class="warning-box">
                    <h4>âš ï¸ æ³¨æ„</h4>
                    <p style="font-size: 0.9em;">
                        é•·æœŸæŠ•è³‡ã§ã¯è¤‡åˆ©åŠ¹æœã¨ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æ¸›ä¾¡ã®ä¸¡æ–¹ãŒå½±éŸ¿ã—ã¾ã™
                    </p>
                </div>
                
                <div class="info-box" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <h4 style="color: #2e7d32;">âœ… ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«</h4>
                    <p style="font-size: 0.9em;">
                        <strong>2æ®µéšæ—¥æ¬¡ãƒªãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ‡ãƒ«</strong>ã‚’æ¡ç”¨<br>
                        <strong>ã‚¹ãƒ†ãƒƒãƒ—1:</strong> åŸæŒ‡æ•°ï¼ˆSOXï¼‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³<br>
                        <strong>ã‚¹ãƒ†ãƒƒãƒ—2:</strong> ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFãŒåŸæŒ‡æ•°ã«é€£å‹•<br>
                        â€¢ åŸæŒ‡æ•°ã®æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ã‚’Lå€ã«å¢—å¹…<br>
                        â€¢ æ¯æ—¥ã‚³ã‚¹ãƒˆã‚’æ§é™¤<br>
                        â€¢ å®Ÿéš›ã®ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã®å‹•ä½œã‚’æ­£ç¢ºã«å†ç¾
                    </p>
                </div>
                
                <div class="warning-box" style="margin-top: 15px;">
                    <h4>âš ï¸ å®Ÿéš›ã®æ ªä¾¡ã¨ã®ä¹–é›¢ã«ã¤ã„ã¦</h4>
                    <p style="font-size: 0.9em;">
                        <strong>ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€Œä¸ç¢ºå®Ÿæ€§ã€ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–</strong><br>
                        â€¢ å®Ÿéš›ã®æ ªä¾¡ã¯ã€Œ1ã¤ã®å®Ÿç¾å€¤ã€<br>
                        â€¢ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€Œèµ·ã“ã‚Šã†ã‚‹ç„¡æ•°ã®å¯èƒ½æ€§ã€<br>
                        â€¢ éå»ã®å®Ÿç¸¾â‰ æœªæ¥ã®ç¢ºç‡åˆ†å¸ƒ<br>
                        â€¢ ãƒ‰ãƒªãƒ•ãƒˆ(Î¼)ã¯éå»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¨å®šã—ãŸä»®å®šå€¤<br>
                        <br>
                        <strong>ğŸ’¡ ç•°ãªã‚‹è¦–ç‚¹:</strong><br>
                        å®Ÿéš›ã®æ ªä¾¡ = å¤©æ°—äºˆå ±ã®ã€Œå®Ÿéš›ã®å¤©æ°—ã€<br>
                        ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ = å¤©æ°—äºˆå ±ã®ã€Œé™æ°´ç¢ºç‡åˆ†å¸ƒã€
                    </p>
                </div>
            </div>
            
            <div class="main">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>æŠ•è³‡æœŸé–“</h3>
                        <div class="value" id="period-display">1å¹´</div>
                    </div>
                    <div class="stat-card">
                        <h3>ãƒªã‚¹ã‚¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </h3>
                        <div class="value" id="risk-premium">0.180</div>
                    </div>
                    <div class="stat-card">
                        <h3>ä¸­å¤®å€¤å„ªä½ä¸Šé™</h3>
                        <div class="value" id="median-limit">L = 8.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>æœ€é »å€¤å„ªä½ä¸Šé™</h3>
                        <div class="value" id="mode-limit">L = 2.00</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ“ˆ ã‚°ãƒ©ãƒ•1: è³‡ç”£åˆ†å¸ƒã®æ¯”è¼ƒï¼ˆæŠ•è³‡æœŸé–“: <span id="chart1-period">1</span>å¹´å¾Œï¼‰</div>
                    <div id="distribution-chart"></div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                            <div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">æœŸå¾…å€¤æ¯”</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="mean-ratio">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">ä¸­å¤®å€¤æ¯”</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #28a745;" id="median-ratio">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">æœ€é »å€¤æ¯”</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;" id="mode-ratio">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="chart-title" style="margin-bottom: 0;">ğŸ² ã‚°ãƒ©ãƒ•2: ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåˆæœŸæŠ•è³‡100ä¸‡å††ã€æŠ•è³‡æœŸé–“: <span id="chart3-period">1</span>å¹´ã€<span id="chart3-simulations">100</span>å›è©¦è¡Œã€æ—¥æ¬¡è¨ˆç®—ãƒ»252å–¶æ¥­æ—¥/å¹´ï¼‰</div>
                        <div>
                            <button id="toggle-log-scale" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆ‡æ›¿
                            </button>
                        </div>
                    </div>
                    <div id="montecarlo-chart"></div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px; font-size: 1em;">L=1 é€šå¸¸ETF (<span id="sim-count-1">100</span>å›ã®çµæœ)</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div style="color: #666;">å¹³å‡å€¤:</div>
                                    <div style="font-weight: bold; color: #0066cc;" id="mc-mean-1">-</div>
                                    <div style="color: #666;">ç†è«–æœŸå¾…å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-mean-1">-</div>
                                    <div style="color: #666;">ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #0066cc;" id="mc-median-1">-</div>
                                    <div style="color: #666;">ç†è«–ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-median-1">-</div>
                                    <div style="color: #666;">ç†è«–æœ€é »å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-mode-1">-</div>
                                    <div style="color: #666;">æœ€å¤§å€¤:</div>
                                    <div style="font-weight: bold; color: #28a745;" id="mc-max-1">-</div>
                                    <div style="color: #666;">æœ€å°å€¤:</div>
                                    <div style="font-weight: bold; color: #dc3545;" id="mc-min-1">-</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px; font-size: 1em;">L=<span id="mc-L-display">3.0</span> ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF (<span id="sim-count-L">100</span>å›ã®çµæœ)</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div style="color: #666;">å¹³å‡å€¤:</div>
                                    <div style="font-weight: bold; color: #ff8c00;" id="mc-mean-L">-</div>
                                    <div style="color: #666;">ç†è«–æœŸå¾…å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-mean-L">-</div>
                                    <div style="color: #666;">ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #ff8c00;" id="mc-median-L">-</div>
                                    <div style="color: #666;">ç†è«–ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-median-L">-</div>
                                    <div style="color: #666;">ç†è«–æœ€é »å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="mc-theory-mode-L">-</div>
                                    <div style="color: #666;">æœ€å¤§å€¤:</div>
                                    <div style="font-weight: bold; color: #28a745;" id="mc-max-L">-</div>
                                    <div style="color: #666;">æœ€å°å€¤:</div>
                                    <div style="font-weight: bold; color: #dc3545;" id="mc-min-L">-</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; font-size: 0.9em;">
                            <strong>ğŸ’¡ ç†è«–å€¤ã®è¦‹æ–¹ï¼š</strong><br>
                            <span style="color: #666;">
                            â€¢ <strong>æœŸå¾…å€¤ï¼ˆç ´ç·šï¼‰</strong>ï¼šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¹³å‡ã«è¿‘ã„ï¼ˆå°‘æ•°ã®å¤§æˆåŠŸãŒå¼•ãä¸Šã’ã‚‹ï¼‰<br>
                            â€¢ <strong>ä¸­å¤®å€¤ï¼ˆå®Ÿç·šï¼‰</strong>ï¼šåŠæ•°ãŒã“ã‚Œã‚ˆã‚Šä¸Šã€åŠæ•°ãŒä¸‹<br>
                            â€¢ <strong>æœ€é »å€¤ï¼ˆç‚¹ç·šï¼‰</strong>ï¼šç¢ºç‡å¯†åº¦ãŒæœ€å¤§ã®ç‚¹ï¼ˆè©¦è¡Œå›æ•°ãŒå¤šã„ã»ã©æ˜ç¢ºã«ãªã‚‹ï¼‰
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š ã‚°ãƒ©ãƒ•3: ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æœ€çµ‚è³‡ç”£åˆ†å¸ƒï¼ˆ<span id="chart4-period">1</span>å¹´å¾Œã€<span id="chart4-simulations">100</span>å›è©¦è¡Œï¼‰</div>
                    <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                        <button id="toggle-dist-x-scale" style="
                            padding: 8px 16px;
                            background: #667eea;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 0.9em;
                            font-weight: bold;
                            transition: all 0.3s;
                        ">Xè»¸: ç·šå½¢ã«åˆ‡æ›¿</button>
                        <button id="toggle-dist-y-scale" style="
                            padding: 8px 16px;
                            background: #667eea;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 0.9em;
                            font-weight: bold;
                            transition: all 0.3s;
                        ">Yè»¸: å¯¾æ•°ã«åˆ‡æ›¿</button>
                    </div>
                    <div style="position: relative; height: 450px;">
                        <canvas id="distribution-mc-chart"></canvas>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px; font-size: 1em;">L=1 é€šå¸¸ETF åˆ†å¸ƒçµ±è¨ˆ</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div style="color: #666;">å®Ÿæ¸¬å¹³å‡:</div>
                                    <div style="font-weight: bold; color: #0066cc;" id="dist-mean-1">-</div>
                                    <div style="color: #666;">ç†è«–æœŸå¾…å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="dist-theory-mean-1">-</div>
                                    <div style="color: #666;">å®Ÿæ¸¬ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #0066cc;" id="dist-median-1">-</div>
                                    <div style="color: #666;">ç†è«–ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="dist-theory-median-1">-</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px; font-size: 1em;">L=<span id="dist-L-display">3.0</span> ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF åˆ†å¸ƒçµ±è¨ˆ</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div style="color: #666;">å®Ÿæ¸¬å¹³å‡:</div>
                                    <div style="font-weight: bold; color: #ff8c00;" id="dist-mean-L">-</div>
                                    <div style="color: #666;">ç†è«–æœŸå¾…å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="dist-theory-mean-L">-</div>
                                    <div style="color: #666;">å®Ÿæ¸¬ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #ff8c00;" id="dist-median-L">-</div>
                                    <div style="color: #666;">ç†è«–ä¸­å¤®å€¤:</div>
                                    <div style="font-weight: bold; color: #666;" id="dist-theory-median-L">-</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 4px solid #0066cc; border-radius: 5px; font-size: 0.9em;">
                            <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong><br>
                            <span style="color: #666;">
                            è©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™ã»ã©ã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãŒç†è«–åˆ†å¸ƒæ›²ç·šï¼ˆå®Ÿç·šï¼‰ã«è¿‘ã¥ãã¾ã™ã€‚<br>
                            10,000å›ã§å®Ÿæ¸¬å€¤ã¨ç†è«–å€¤ãŒã»ã¼ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ† ã‚°ãƒ©ãƒ•4: ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF vs é€šå¸¸ETF å‹æ•—ï¼ˆ<span id="chart4-win-simulations">100</span>å›è©¦è¡Œï¼‰</div>
                    <div style="position: relative; height: 400px; max-width: 500px; margin: 0 auto;">
                        <canvas id="win-loss-chart"></canvas>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center;">
                            <div>
                                <h4 style="color: #ff8c00; margin-bottom: 10px; font-size: 1.1em;">ğŸ† L=<span id="win-L-display">3.0</span> å‹åˆ©</h4>
                                <div style="font-size: 2em; font-weight: bold; color: #ff8c00;" id="leverage-wins">-</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    å‹ç‡: <span style="font-weight: bold; color: #ff8c00;" id="leverage-win-rate">-</span>
                                </div>
                            </div>
                            <div>
                                <h4 style="color: #0066cc; margin-bottom: 10px; font-size: 1.1em;">ğŸ›¡ï¸ L=1 å‹åˆ©</h4>
                                <div style="font-size: 2em; font-weight: bold; color: #0066cc;" id="normal-wins">-</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    å‹ç‡: <span style="font-weight: bold; color: #0066cc;" id="normal-win-rate">-</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; font-size: 0.9em;">
                            <strong>ğŸ’¡ å‹æ•—ã®åˆ¤å®šï¼š</strong><br>
                            <span style="color: #666;">
                            å„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©¦è¡Œã§ã€<span id="chart4-period-display">1</span>å¹´å¾Œã®æœ€çµ‚è³‡ç”£é¡ã‚’æ¯”è¼ƒã€‚<br>
                            ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFï¼ˆL=<span id="win-L-display2">3.0</span>ï¼‰ã®è³‡ç”£ãŒé€šå¸¸ETFï¼ˆL=1ï¼‰ã‚ˆã‚Šå¤šã‘ã‚Œã°ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã®å‹åˆ©ã€‚<br>
                            è©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™ã»ã©ã€å‹ç‡ã®ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ’¥ ã‚°ãƒ©ãƒ•5: ç ´ç”£ç¢ºç‡ï¼ˆè³‡ç”£ãŒåˆæœŸå€¤ã®1/4ä»¥ä¸‹ã«ãªã‚‹ç¢ºç‡ã€<span id="chart5-simulations">100</span>å›è©¦è¡Œï¼‰</div>
                    <div style="position: relative; height: 400px; max-width: 600px; margin: 0 auto;">
                        <canvas id="bankruptcy-chart"></canvas>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center;">
                            <div>
                                <h4 style="color: #0066cc; margin-bottom: 10px; font-size: 1.1em;">ğŸ›¡ï¸ L=1 é€šå¸¸ETF</h4>
                                <div style="font-size: 2em; font-weight: bold; color: #0066cc;" id="normal-bankruptcy-rate">-</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ç ´ç”£å›æ•°: <span style="font-weight: bold; color: #0066cc;" id="normal-bankruptcy-count">-</span>
                                </div>
                            </div>
                            <div>
                                <h4 style="color: #ff8c00; margin-bottom: 10px; font-size: 1.1em;">ğŸ’¥ L=<span id="bankruptcy-L-display">3.0</span> ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF</h4>
                                <div style="font-size: 2em; font-weight: bold; color: #ff8c00;" id="leverage-bankruptcy-rate">-</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ç ´ç”£å›æ•°: <span style="font-weight: bold; color: #ff8c00;" id="leverage-bankruptcy-count">-</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #ffebee; border-left: 4px solid #dc3545; border-radius: 5px; font-size: 0.9em;">
                            <strong>ğŸ’¡ ç ´ç”£ã®å®šç¾©ï¼š</strong><br>
                            <span style="color: #666;">
                            å„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©¦è¡Œã§ã€<span id="chart5-period-display">1</span>å¹´å¾Œã®æœ€çµ‚è³‡ç”£ãŒåˆæœŸæŠ•è³‡é¡ï¼ˆ100ä¸‡å††ï¼‰ã®<strong>1/4ï¼ˆ25ä¸‡å††ï¼‰ä»¥ä¸‹</strong>ã«ãªã£ãŸå ´åˆã‚’ã€Œç ´ç”£ã€ã¨å®šç¾©ã€‚<br>
                            ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã¯ã€ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ‰ãƒ©ãƒƒã‚°ã«ã‚ˆã‚Šé€šå¸¸ETFã‚ˆã‚Šç ´ç”£ç¢ºç‡ãŒé«˜ããªã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚<br>
                            è©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™ã»ã©ã€ç ´ç”£ç¢ºç‡ã®ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart.js ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let distributionChart = null;
        let winLossChart = null;
        let bankruptcyChart = null;
        
        // ã‚°ãƒ©ãƒ•4ã®ã‚¹ã‚±ãƒ¼ãƒ«çŠ¶æ…‹
        let distScaleState = {
            xScale: 'logarithmic', // 'logarithmic' or 'linear'
            yScale: 'linear' // 'linear' or 'logarithmic'
        };
        
        // æ•°å­¦é–¢æ•°
        function lognormalPDF(x, alpha, beta) {
            if (x <= 0 || beta <= 0) return 0;
            return (1 / (x * beta * Math.sqrt(2 * Math.PI))) * 
                   Math.exp(-Math.pow(Math.log(x) - alpha, 2) / (2 * beta * beta));
        }
        
        function lognormalMedian(alpha, initialValue = 1) {
            return initialValue * Math.exp(alpha);
        }
        
        function lognormalMean(alpha, beta, initialValue = 1) {
            return initialValue * Math.exp(alpha + beta * beta / 2);
        }
        
        function lognormalMode(alpha, beta, initialValue = 1) {
            return initialValue * Math.exp(alpha - beta * beta);
        }
        
        function getParams(L, mu, sigma, b, c, T) {
            const sigma2 = sigma * sigma;
            // Tå¹´å¾Œã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆæ—¥æ¬¡ãƒªãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ‡ãƒ«ã®ç†è«–å€¤ï¼‰
            // log(S_T / S_0) ~ N(alpha, beta^2)
            // æ—¥æ¬¡ãƒªãƒãƒ©ãƒ³ã‚¹: æ¯æ—¥ L*r_t ã‚’ä¹—ã˜ãŸçµæœã®ç´¯ç©åˆ†å¸ƒ
            // alpha = T * [L*Î¼ - (L-1)*b - c - 0.5*LÂ²*ÏƒÂ²] (æœŸå¾…å¯¾æ•°ãƒªã‚¿ãƒ¼ãƒ³)
            // beta = sqrt(T) * L * Ïƒ (ç´¯ç©ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£)
            const alpha = T * (L * mu - (L - 1) * b - c - 0.5 * L * L * sigma2);
            const beta = Math.sqrt(T) * L * sigma;
            return { alpha, beta };
        }
        
        // Box-Mulleræ³•ã§æ­£è¦ä¹±æ•°ã‚’ç”Ÿæˆ
        function randomNormal() {
            const u1 = Math.random();
            const u2 = Math.random();
            return Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
        }
        
        // 2æ®µéšãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ˆã‚Šç¾å®Ÿçš„ãªãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFãƒ¢ãƒ‡ãƒ«ï¼‰
        // åŸæŒ‡æ•°ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å…±æœ‰ï¼‰
        function generateIndexSimulations(mu, sigma, T, numSimulations) {
            const tradingDaysPerYear = 252;
            const totalDays = T * tradingDaysPerYear;
            const dt = 1 / tradingDaysPerYear;
            const EPS = 1e-10;
            
            const indexSimulations = [];
            
            for (let sim = 0; sim < numSimulations; sim++) {
                const indexPrices = [100]; // åŸæŒ‡æ•°ã®åˆæœŸå€¤ã¯100
                let currentIndexPrice = 100;
                
                for (let day = 1; day <= totalDays; day++) {
                    const dW = randomNormal();
                    const indexReturn = (mu - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * dW;
                    currentIndexPrice = Math.max(EPS, currentIndexPrice * Math.exp(indexReturn));
                    indexPrices.push(currentIndexPrice);
                }
                
                indexSimulations.push(indexPrices);
            }
            
            return indexSimulations;
        }
        
        // ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåŸæŒ‡æ•°ã‹ã‚‰è¿½è·¡ï¼‰
        function trackIndexWithLeverage(indexSimulations, L, b, c, sigma, initialValue = 100) {
            const tradingDaysPerYear = 252;
            const dt = 1 / tradingDaysPerYear;
            const EPS = 1e-10;
            
            // ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ‰ãƒ©ãƒƒã‚°ã®è£œæ­£é …ã‚’è¨ˆç®—
            // ç†è«–å€¤: 0.5 * LÂ² * ÏƒÂ²
            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹åˆ†: 0.5 * L * ÏƒÂ²
            // ä¸è¶³åˆ†: 0.5 * L * (L-1) * ÏƒÂ²
            const sigma2 = sigma * sigma;
            
            const trajectories = [];
            
            for (let sim = 0; sim < indexSimulations.length; sim++) {
                const indexPrices = indexSimulations[sim];
                const trajectory = [initialValue];
                let currentETFValue = initialValue;
                
                for (let day = 1; day < indexPrices.length; day++) {
                    // åŸæŒ‡æ•°ã®æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ã‚’è¨ˆç®—
                    const dailyIndexReturn = Math.log(indexPrices[day] / indexPrices[day - 1]);
                    
                    // ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã¯åŸæŒ‡æ•°ã®æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ã‚’Lå€ã«å¢—å¹…
                    const leveragedReturn = L * dailyIndexReturn;
                    
                    // ä¸è¶³ã—ã¦ã„ã‚‹ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ‰ãƒ©ãƒƒã‚°ã‚’è¨ˆç®—
                    // (0.5 * LÂ² * ÏƒÂ²) - (0.5 * L * ÏƒÂ²) = 0.5 * L * (L-1) * ÏƒÂ²
                    const missingDecay = 0.5 * L * (L - 1) * sigma2 * dt;
                    
                    // ã‚³ã‚¹ãƒˆãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã«ä¸è¶³åˆ†ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚’è¿½åŠ 
                    const costFactor = Math.exp(-(L - 1) * b * dt - c * dt - missingDecay);
                    
                    currentETFValue = Math.max(EPS, currentETFValue * Math.exp(leveragedReturn) * costFactor);
                    trajectory.push(currentETFValue);
                }
                
                trajectories.push(trajectory);
            }
            
            return trajectories;
        }
        
        // æœ€çµ‚å€¤ã‚’å–å¾—
        function getFinalValues(trajectories) {
            return trajectories.map(traj => traj[traj.length - 1]);
        }
        
        // çµ±è¨ˆé‡è¨ˆç®—
        function calculateStats(data) {
            const sorted = [...data].sort((a, b) => a - b);
            const mean = data.reduce((a, b) => a + b, 0) / data.length;
            const median = sorted[Math.floor(sorted.length / 2)];
            const min = Math.min(...data);
            const max = Math.max(...data);
            
            return { mean, median, min, max };
        }
        
        function updateCharts() {
            const T = parseInt(document.getElementById('T').value);
            const L = parseFloat(document.getElementById('L').value);
            const mu = parseFloat(document.getElementById('mu').value);
            const sigma = parseFloat(document.getElementById('sigma').value);
            const b = parseFloat(document.getElementById('b').value);
            const c = parseFloat(document.getElementById('c').value);
            const numSimulations = parseInt(document.getElementById('simulations').value);
            const yMax = parseInt(document.getElementById('ymax').value);
            
            // Yè»¸æœ€å¤§å€¤ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
            window.linearYMax = yMax;
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¡¨ç¤ºæ›´æ–°ï¼ˆã‚°ãƒ©ãƒ•é–¢é€£ã®ã¿ï¼‰
            document.getElementById('period-display').textContent = T + 'å¹´';
            document.getElementById('chart1-period').textContent = T;
            
            // çµ±è¨ˆé‡è¨ˆç®—ï¼ˆæœŸé–“ã«ä¾å­˜ã—ãªã„ï¼‰
            const riskPremium = mu - b;
            const sigma2 = sigma * sigma;
            const medianLimit = (2 * riskPremium / sigma2) - 1;
            const modeLimit = (2 * riskPremium / (3 * sigma2)) - 1;
            
            document.getElementById('risk-premium').textContent = riskPremium.toFixed(3);
            document.getElementById('median-limit').textContent = 'L = ' + medianLimit.toFixed(2);
            document.getElementById('mode-limit').textContent = 'L = ' + modeLimit.toFixed(2);
            
            // L=1ã¨L=Lã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’Tå¹´ã§è¨ˆç®—
            const params1 = getParams(1, mu, sigma, b, c, T);
            const paramsL = getParams(L, mu, sigma, b, c, T);
            
            // Xè»¸ã®ç¯„å›²ã‚’æŠ•è³‡æœŸé–“ã«å¿œã˜ã¦èª¿æ•´
            const xMax = Math.min(Math.max(10, T * 2), 50);
            
            // åˆ†å¸ƒã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const x = [];
            const pdf1 = [];
            const pdfL = [];
            
            for (let i = 0.01; i <= xMax; i += xMax/1000) {
                x.push(i);
                pdf1.push(lognormalPDF(i, params1.alpha, params1.beta));
                pdfL.push(lognormalPDF(i, paramsL.alpha, paramsL.beta));
            }
            
            const mean1 = lognormalMean(params1.alpha, params1.beta);
            const median1 = lognormalMedian(params1.alpha);
            const mode1 = lognormalMode(params1.alpha, params1.beta);
            
            const meanL = lognormalMean(paramsL.alpha, paramsL.beta);
            const medianL = lognormalMedian(paramsL.alpha);
            const modeL = lognormalMode(paramsL.alpha, paramsL.beta);
            
            // æ¯”ç‡ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
            const meanRatio = meanL / mean1;
            const medianRatio = medianL / median1;
            const modeRatio = modeL / mode1;
            
            document.getElementById('mean-ratio').textContent = meanRatio.toFixed(3) + 'x';
            document.getElementById('mean-ratio').style.color = meanRatio >= 1 ? '#28a745' : '#dc3545';
            
            document.getElementById('median-ratio').textContent = medianRatio.toFixed(3) + 'x';
            document.getElementById('median-ratio').style.color = medianRatio >= 1 ? '#28a745' : '#dc3545';
            
            document.getElementById('mode-ratio').textContent = modeRatio.toFixed(3) + 'x';
            document.getElementById('mode-ratio').style.color = modeRatio >= 1 ? '#28a745' : '#dc3545';
            
            // åˆ†å¸ƒã‚°ãƒ©ãƒ•æç”»
            const distributionData = [
                {
                    x: x,
                    y: pdf1,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'L=1 é€šå¸¸ETF',
                    line: { color: 'blue', width: 3 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(0,0,255,0.1)'
                },
                {
                    x: x,
                    y: pdfL,
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF`,
                    line: { color: 'darkorange', width: 3 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(255,140,0,0.1)'
                },
                {
                    x: [mean1, mean1],
                    y: [0, Math.max(...pdf1) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=1 æœŸå¾…å€¤: ${mean1.toFixed(2)}`,
                    line: { color: 'blue', dash: 'dot', width: 2 }
                },
                {
                    x: [median1, median1],
                    y: [0, Math.max(...pdf1) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=1 ä¸­å¤®å€¤: ${median1.toFixed(2)}`,
                    line: { color: 'blue', dash: 'dash', width: 2 }
                },
                {
                    x: [mode1, mode1],
                    y: [0, Math.max(...pdf1) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=1 æœ€é »å€¤: ${mode1.toFixed(2)}`,
                    line: { color: 'blue', dash: 'dashdot', width: 2 }
                },
                {
                    x: [meanL, meanL],
                    y: [0, Math.max(...pdfL) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} æœŸå¾…å€¤: ${meanL.toFixed(2)}`,
                    line: { color: 'darkorange', dash: 'dot', width: 2 }
                },
                {
                    x: [medianL, medianL],
                    y: [0, Math.max(...pdfL) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} ä¸­å¤®å€¤: ${medianL.toFixed(2)}`,
                    line: { color: 'darkorange', dash: 'dash', width: 2 }
                },
                {
                    x: [modeL, modeL],
                    y: [0, Math.max(...pdfL) * 0.8],
                    type: 'scatter',
                    mode: 'lines',
                    name: `L=${L} æœ€é »å€¤: ${modeL.toFixed(2)}`,
                    line: { color: 'darkorange', dash: 'dashdot', width: 2 }
                }
            ];
            
            const distributionLayout = {
                xaxis: { 
                    title: `${T}å¹´å¾Œã®è³‡ç”£å€ç‡ (å…ƒæœ¬=1)`, 
                    range: [0, xMax]
                },
                yaxis: { title: 'ç¢ºç‡å¯†åº¦' },
                showlegend: true,
                legend: { x: 0.65, y: 1, font: { size: 9 } },
                margin: { l: 60, r: 20, t: 20, b: 60 },
                height: 450
            };
            
            Plotly.newPlot('distribution-chart', distributionData, distributionLayout, {responsive: true});
            
            // ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æ¬¡ï¼‰
            document.getElementById('chart3-period').textContent = T;
            document.getElementById('chart3-simulations').textContent = numSimulations;
            document.getElementById('sim-count-1').textContent = numSimulations;
            document.getElementById('sim-count-L').textContent = numSimulations;
            document.getElementById('mc-L-display').textContent = L.toFixed(1);
            
            const tradingDaysPerYear = 252; // ç±³å›½å¸‚å ´ã®å¹³å‡å–¶æ¥­æ—¥æ•°ã«çµ±ä¸€
            const totalDays = T * tradingDaysPerYear;
            
            const initialValue = 100; // åˆæœŸæŠ•è³‡é¡: 100ä¸‡å††
            
            // æ—¥æ¬¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆå‹•çš„ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°ï¼‰
            // ã‚¹ãƒ†ãƒƒãƒ—1: åŸæŒ‡æ•°ã‚’ç”Ÿæˆï¼ˆå…¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å…±æœ‰ï¼‰
            const indexSimulations = generateIndexSimulations(mu, sigma, T, numSimulations);
            
            // ã‚¹ãƒ†ãƒƒãƒ—2: åŒã˜åŸæŒ‡æ•°ã‹ã‚‰ L=1 ã¨ L=è¨­å®šå€¤ ã®ä¸¡æ–¹ã®ETFã‚’è¿½è·¡
            const trajectories1 = trackIndexWithLeverage(indexSimulations, 1, b, c, sigma, initialValue);
            const trajectoriesL = trackIndexWithLeverage(indexSimulations, L, b, c, sigma, initialValue);
            
            // æœ€çµ‚å€¤ã®çµ±è¨ˆ
            const finalValues1 = getFinalValues(trajectories1);
            const finalValuesL = getFinalValues(trajectoriesL);
            
            const stats1 = calculateStats(finalValues1);
            const statsL = calculateStats(finalValuesL);
            
            // ç†è«–å€¤ã‚’è¨ˆç®—
            const params1_final = getParams(1, mu, sigma, b, c, T);
            const paramsL_final = getParams(L, mu, sigma, b, c, T);
            
            const theoryMean1 = lognormalMean(params1_final.alpha, params1_final.beta, initialValue);
            const theoryMedian1 = lognormalMedian(params1_final.alpha, initialValue);
            const theoryMode1 = lognormalMode(params1_final.alpha, params1_final.beta, initialValue);
            const theoryMeanL = lognormalMean(paramsL_final.alpha, paramsL_final.beta, initialValue);
            const theoryMedianL = lognormalMedian(paramsL_final.alpha, initialValue);
            const theoryModeL = lognormalMode(paramsL_final.alpha, paramsL_final.beta, initialValue);
            
            // çµ±è¨ˆé‡è¡¨ç¤ºï¼ˆä¸‡å††å˜ä½ï¼‰
            document.getElementById('mc-mean-1').textContent = stats1.mean.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-mean-1').textContent = theoryMean1.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-median-1').textContent = stats1.median.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-median-1').textContent = theoryMedian1.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-mode-1').textContent = theoryMode1.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-max-1').textContent = stats1.max.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-min-1').textContent = stats1.min.toFixed(1) + 'ä¸‡å††';
            
            document.getElementById('mc-mean-L').textContent = statsL.mean.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-mean-L').textContent = theoryMeanL.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-median-L').textContent = statsL.median.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-median-L').textContent = theoryMedianL.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-theory-mode-L').textContent = theoryModeL.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-max-L').textContent = statsL.max.toFixed(1) + 'ä¸‡å††';
            document.getElementById('mc-min-L').textContent = statsL.min.toFixed(1) + 'ä¸‡å††';
            
            // ã‚°ãƒ©ãƒ•ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆè¡¨ç¤ºç”¨ã«é–“å¼•ãï¼‰
            const samplingInterval = Math.max(1, Math.floor(totalDays / 500)); // æœ€å¤§500ãƒã‚¤ãƒ³ãƒˆ
            const montecarloData = [];
            
            // L=1ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è»Œè·¡ï¼ˆã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰
            // å¤šã™ãã‚‹å ´åˆã¯é€æ˜åº¦ã‚’ä¸Šã’ã‚‹
            const lineOpacity = numSimulations <= 100 ? 0.15 : Math.max(0.02, 15 / numSimulations);
            
            for (let i = 0; i < numSimulations; i++) {
                const sampledX = [];
                const sampledY = [];
                for (let d = 0; d <= totalDays; d += samplingInterval) {
                    const index = Math.min(Math.floor(d), trajectories1[i].length - 1);
                    sampledX.push(d / tradingDaysPerYear); // å¹´å˜ä½ã«å¤‰æ›
                    sampledY.push(trajectories1[i][index]);
                }
                montecarloData.push({
                    x: sampledX,
                    y: sampledY,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: `rgba(0, 0, 255, ${lineOpacity})`, width: 1 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
            
            // L=Lã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è»Œè·¡ï¼ˆã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰
            for (let i = 0; i < numSimulations; i++) {
                const sampledX = [];
                const sampledY = [];
                for (let d = 0; d <= totalDays; d += samplingInterval) {
                    const index = Math.min(Math.floor(d), trajectoriesL[i].length - 1);
                    sampledX.push(d / tradingDaysPerYear); // å¹´å˜ä½ã«å¤‰æ›
                    sampledY.push(trajectoriesL[i][index]);
                }
                montecarloData.push({
                    x: sampledX,
                    y: sampledY,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: `rgba(255, 140, 0, ${lineOpacity})`, width: 1 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
            
            // ç†è«–å€¤ã®è»Œè·¡ï¼ˆå¹´å˜ä½ï¼‰
            const yearPoints = [];
            const expectedPath1 = [];
            const expectedPathL = [];
            const medianPath1 = [];
            const medianPathL = [];
            const modePath1 = [];
            const modePathL = [];
            
            for (let y = 0; y <= T; y += 0.1) {
                yearPoints.push(y);
                if (y === 0) {
                    expectedPath1.push(initialValue);
                    expectedPathL.push(initialValue);
                    medianPath1.push(initialValue);
                    medianPathL.push(initialValue);
                    modePath1.push(initialValue);
                    modePathL.push(initialValue);
                } else {
                    const p1 = getParams(1, mu, sigma, b, c, y);
                    const pL = getParams(L, mu, sigma, b, c, y);
                    expectedPath1.push(lognormalMean(p1.alpha, p1.beta, initialValue));
                    expectedPathL.push(lognormalMean(pL.alpha, pL.beta, initialValue));
                    medianPath1.push(lognormalMedian(p1.alpha, initialValue));
                    medianPathL.push(lognormalMedian(pL.alpha, initialValue));
                    modePath1.push(lognormalMode(p1.alpha, p1.beta, initialValue));
                    modePathL.push(lognormalMode(pL.alpha, pL.beta, initialValue));
                }
            }
            
            // ç†è«–æœŸå¾…å€¤ï¼ˆç ´ç·šï¼‰
            montecarloData.push({
                x: yearPoints,
                y: expectedPath1,
                type: 'scatter',
                mode: 'lines',
                name: 'L=1 ç†è«–æœŸå¾…å€¤',
                line: { color: 'blue', width: 3, dash: 'dash' }
            });
            
            montecarloData.push({
                x: yearPoints,
                y: expectedPathL,
                type: 'scatter',
                mode: 'lines',
                name: `L=${L} ç†è«–æœŸå¾…å€¤`,
                line: { color: 'darkorange', width: 3, dash: 'dash' }
            });
            
            // ç†è«–ä¸­å¤®å€¤ï¼ˆå®Ÿç·šãƒ»ç´°ã‚ï¼‰
            montecarloData.push({
                x: yearPoints,
                y: medianPath1,
                type: 'scatter',
                mode: 'lines',
                name: 'L=1 ç†è«–ä¸­å¤®å€¤',
                line: { color: 'blue', width: 2, dash: 'solid' }
            });
            
            montecarloData.push({
                x: yearPoints,
                y: medianPathL,
                type: 'scatter',
                mode: 'lines',
                name: `L=${L} ç†è«–ä¸­å¤®å€¤`,
                line: { color: 'darkorange', width: 2, dash: 'solid' }
            });
            
            // ç†è«–æœ€é »å€¤ï¼ˆç‚¹ç·šï¼‰
            montecarloData.push({
                x: yearPoints,
                y: modePath1,
                type: 'scatter',
                mode: 'lines',
                name: 'L=1 ç†è«–æœ€é »å€¤',
                line: { color: 'blue', width: 3, dash: 'dot' }
            });
            
            montecarloData.push({
                x: yearPoints,
                y: modePathL,
                type: 'scatter',
                mode: 'lines',
                name: `L=${L} ç†è«–æœ€é »å€¤`,
                line: { color: 'darkorange', width: 3, dash: 'dot' }
            });
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿å­˜ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰
            window.montecarloData = montecarloData;
            window.montecarloT = T;
            
            const yAxisConfig = window.isLogScale !== false 
                ? { title: 'è³‡ç”£é¡ (ä¸‡å††)', type: 'log' }
                : { title: 'è³‡ç”£é¡ (ä¸‡å††)', type: 'linear', range: [0, window.linearYMax || 1000] };
            
            const montecarloLayout = {
                xaxis: { title: 'æŠ•è³‡å¹´æ•°', range: [0, T] },
                yaxis: yAxisConfig,
                showlegend: true,
                legend: { x: 0.02, y: 0.98 },
                margin: { l: 60, r: 20, t: 20, b: 60 },
                height: 500
            };
            
            Plotly.newPlot('montecarlo-chart', montecarloData, montecarloLayout, {responsive: true});
            
            // ã‚°ãƒ©ãƒ•4: ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æœ€çµ‚è³‡ç”£åˆ†å¸ƒï¼ˆChart.jsç‰ˆï¼‰
            document.getElementById('chart4-period').textContent = T;
            document.getElementById('chart4-simulations').textContent = numSimulations;
            document.getElementById('dist-L-display').textContent = L.toFixed(1);
            
            // å€ç‡ã«å¤‰æ›ï¼ˆå…ƒæœ¬=100ä¸‡å†† â†’ å€ç‡ï¼‰
            const finalRatios1 = finalValues1.map(v => v / initialValue);
            const finalRatiosL = finalValuesL.map(v => v / initialValue);
            
            const statsRatio1 = calculateStats(finalRatios1);
            const statsRatioL = calculateStats(finalRatiosL);
            
            // ç†è«–å€¤ã‚‚å€ç‡ã§
            const theoryMeanRatio1 = theoryMean1 / initialValue;
            const theoryMedianRatio1 = theoryMedian1 / initialValue;
            const theoryMeanRatioL = theoryMeanL / initialValue;
            const theoryMedianRatioL = theoryMedianL / initialValue;
            
            // çµ±è¨ˆé‡è¡¨ç¤ºï¼ˆå€ç‡ï¼‰
            document.getElementById('dist-mean-1').textContent = statsRatio1.mean.toFixed(3) + 'x';
            document.getElementById('dist-theory-mean-1').textContent = theoryMeanRatio1.toFixed(3) + 'x';
            document.getElementById('dist-median-1').textContent = statsRatio1.median.toFixed(3) + 'x';
            document.getElementById('dist-theory-median-1').textContent = theoryMedianRatio1.toFixed(3) + 'x';
            
            document.getElementById('dist-mean-L').textContent = statsRatioL.mean.toFixed(3) + 'x';
            document.getElementById('dist-theory-mean-L').textContent = theoryMeanRatioL.toFixed(3) + 'x';
            document.getElementById('dist-median-L').textContent = statsRatioL.median.toFixed(3) + 'x';
            document.getElementById('dist-theory-median-L').textContent = theoryMedianRatioL.toFixed(3) + 'x';
            
            // Chart.jsã§ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’æç”»
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰
            window.lastDistributionData = {
                finalRatios1: finalRatios1,
                finalRatiosL: finalRatiosL,
                L: L,
                T: T,
                params1: params1_final,
                paramsL: paramsL_final,
                theoryMean1: theoryMeanRatio1,
                theoryMedian1: theoryMedianRatio1,
                theoryMeanL: theoryMeanRatioL,
                theoryMedianL: theoryMedianRatioL
            };
            
            updateDistributionChart(finalRatios1, finalRatiosL, L, T, 
                params1_final, paramsL_final, 
                theoryMeanRatio1, theoryMedianRatio1, 
                theoryMeanRatioL, theoryMedianRatioL);
            
            // ã‚°ãƒ©ãƒ•4: å‹æ•—å††ã‚°ãƒ©ãƒ•
            updateWinLossChart(finalValues1, finalValuesL, L, T, numSimulations);
            
            // ã‚°ãƒ©ãƒ•5: ç ´ç”£ç¢ºç‡æ£’ã‚°ãƒ©ãƒ•
            updateBankruptcyChart(finalValues1, finalValuesL, L, T, numSimulations, initialValue);
        }
        
        // Chart.jsã§ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’æç”»ã™ã‚‹é–¢æ•°
        function updateDistributionChart(finalRatios1, finalRatiosL, L, T, params1, paramsL, 
            theoryMean1, theoryMedian1, theoryMeanL, theoryMedianL) {
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã®ç¯„å›²ã‚’è¨ˆç®—
            const allRatios = [...finalRatios1, ...finalRatiosL];
            const minRatio = Math.min(...allRatios);
            const maxRatio = Math.max(...allRatios);
            
            // ãƒ“ãƒ³æ•°ã‚’è¨ˆç®—ï¼ˆå¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã§100ãƒ“ãƒ³ï¼‰
            const numBins = 100;
            const logMin = Math.log(Math.max(0.01, minRatio));
            const logMax = Math.log(maxRatio * 1.1);
            const logBinWidth = (logMax - logMin) / numBins;
            
            // ãƒ“ãƒ³ã®ä¸­å¿ƒå€¤ã‚’è¨ˆç®—ï¼ˆå¯¾æ•°ç©ºé–“ã§ç­‰é–“éš”ï¼‰
            const binCenters = [];
            for (let i = 0; i < numBins; i++) {
                const logCenter = logMin + (i + 0.5) * logBinWidth;
                binCenters.push(Math.exp(logCenter));
            }
            
            // ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’ä½œæˆï¼ˆL=1ã¨L=Lã®ä¸¡æ–¹ï¼‰
            const histogram1 = new Array(numBins).fill(0);
            const histogramL = new Array(numBins).fill(0);
            
            finalRatios1.forEach(ratio => {
                if (ratio > 0) {
                    const logRatio = Math.log(ratio);
                    const binIndex = Math.min(Math.floor((logRatio - logMin) / logBinWidth), numBins - 1);
                    if (binIndex >= 0) histogram1[binIndex]++;
                }
            });
            
            finalRatiosL.forEach(ratio => {
                if (ratio > 0) {
                    const logRatio = Math.log(ratio);
                    const binIndex = Math.min(Math.floor((logRatio - logMin) / logBinWidth), numBins - 1);
                    if (binIndex >= 0) histogramL[binIndex]++;
                }
            });
            
            // ç¢ºç‡å¯†åº¦ã«æ­£è¦åŒ–ï¼ˆå¯¾æ•°æ­£è¦åˆ†å¸ƒç”¨ï¼‰
            // å„ãƒ“ãƒ³ã®å®Ÿç©ºé–“ã§ã®å¹…ã‚’è¨ˆç®—
            const binWidths = [];
            for (let i = 0; i < numBins; i++) {
                if (i < numBins - 1) {
                    binWidths.push(binCenters[i + 1] - binCenters[i]);
                } else {
                    binWidths.push(binCenters[i] - binCenters[i - 1]);
                }
            }
            
            // ç·ã‚«ã‚¦ãƒ³ãƒˆã§æ­£è¦åŒ–ï¼ˆç¢ºç‡å¯†åº¦ã«å¤‰æ›ï¼‰
            const total1 = finalRatios1.length;
            const totalL = finalRatiosL.length;
            
            const densities1 = histogram1.map((count, i) => {
                return count / (total1 * binWidths[i]);
            });
            
            const densitiesL = histogramL.map((count, i) => {
                return count / (totalL * binWidths[i]);
            });
            
            // ç†è«–åˆ†å¸ƒæ›²ç·šã®ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const theoryCurvePoints = 500;
            const theoryCurve1 = [];
            const theoryCurveL = [];
            
            for (let i = 0; i < theoryCurvePoints; i++) {
                const ratio = Math.exp(logMin + (i / theoryCurvePoints) * (logMax - logMin));
                theoryCurve1.push({
                    x: ratio,
                    y: lognormalPDF(ratio, params1.alpha, params1.beta)
                });
                theoryCurveL.push({
                    x: ratio,
                    y: lognormalPDF(ratio, paramsL.alpha, paramsL.beta)
                });
            }
            
            // Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æç”»
            const ctx = document.getElementById('distribution-mc-chart').getContext('2d');
            
            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binCenters.map(x => x.toFixed(3)),
                    datasets: [
                        {
                            label: 'L=1 å®Ÿæ¸¬åˆ†å¸ƒ',
                            data: binCenters.map((x, i) => ({ x: x, y: densities1[i] })),
                            backgroundColor: 'rgba(0, 100, 255, 0.5)',
                            borderColor: 'rgba(0, 100, 255, 0.8)',
                            borderWidth: 1,
                            barPercentage: 1.0,
                            categoryPercentage: 1.0,
                            order: 2
                        },
                        {
                            label: `L=${L.toFixed(1)} å®Ÿæ¸¬åˆ†å¸ƒ`,
                            data: binCenters.map((x, i) => ({ x: x, y: densitiesL[i] })),
                            backgroundColor: 'rgba(255, 140, 0, 0.5)',
                            borderColor: 'rgba(255, 140, 0, 0.8)',
                            borderWidth: 1,
                            barPercentage: 1.0,
                            categoryPercentage: 1.0,
                            order: 2
                        },
                        {
                            label: 'L=1 ç†è«–åˆ†å¸ƒ',
                            data: theoryCurve1,
                            type: 'line',
                            borderColor: 'rgb(0, 0, 255)',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: false,
                            order: 1
                        },
                        {
                            label: `L=${L.toFixed(1)} ç†è«–åˆ†å¸ƒ`,
                            data: theoryCurveL,
                            type: 'line',
                            borderColor: 'rgb(255, 140, 0)',
                            backgroundColor: 'rgba(255, 140, 0, 0.1)',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: false,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 11 },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `è³‡ç”£å€ç‡: ${parseFloat(context[0].label).toFixed(2)}x`;
                                },
                                label: function(context) {
                                    if (context.dataset.type === 'line') {
                                        return `${context.dataset.label}: å¯†åº¦ ${context.parsed.y.toFixed(4)}`;
                                    }
                                    return `${context.dataset.label}: å¯†åº¦ ${context.parsed.y.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: distScaleState.xScale,
                            title: {
                                display: true,
                                text: `${T}å¹´å¾Œã®è³‡ç”£å€ç‡ (å…ƒæœ¬=1${distScaleState.xScale === 'logarithmic' ? 'ã€å¯¾æ•°è»¸' : 'ã€ç·šå½¢è»¸'})`,
                                font: { size: 13 }
                            },
                            min: distScaleState.xScale === 'linear' ? 0 : undefined,
                            max: distScaleState.xScale === 'linear' ? Math.min(Math.max(10, T * 2), 50) : undefined,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 10) return value.toFixed(0);
                                    if (value >= 1) return value.toFixed(1);
                                    if (value >= 0.1) return value.toFixed(2);
                                    return value.toFixed(3);
                                }
                            }
                        },
                        y: {
                            type: distScaleState.yScale,
                            title: {
                                display: true,
                                text: `ç¢ºç‡å¯†åº¦${distScaleState.yScale === 'logarithmic' ? 'ï¼ˆå¯¾æ•°è»¸ï¼‰' : ''}`,
                                font: { size: 13 }
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        // Chart.jsã§å‹æ•—å††ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹é–¢æ•°
        function updateWinLossChart(finalValues1, finalValuesL, L, T, numSimulations) {
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (winLossChart) {
                winLossChart.destroy();
            }
            
            // å‹æ•—ã‚’è¨ˆç®—
            let leverageWins = 0;
            let normalWins = 0;
            let ties = 0;
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            console.log('=== å‹æ•—è¨ˆç®—ãƒ‡ãƒãƒƒã‚° ===');
            console.log('è©¦è¡Œå›æ•°:', finalValues1.length);
            console.log('æœ€åˆã®20è©¦è¡Œã®çµæœ:');
            for (let i = 0; i < Math.min(20, finalValues1.length); i++) {
                const ratio1 = finalValues1[i] / 100;
                const ratioL = finalValuesL[i] / 100;
                const winner = finalValuesL[i] > finalValues1[i] ? 'L=' + L : 'L=1';
                console.log(`è©¦è¡Œ${i+1}: L=1=${finalValues1[i].toFixed(2)}ä¸‡å††(${ratio1.toFixed(2)}x), L=${L}=${finalValuesL[i].toFixed(2)}ä¸‡å††(${ratioL.toFixed(2)}x), å‹è€…=${winner}`);
            }
            
            // å…¨è©¦è¡Œã®çµ±è¨ˆ
            const allRatios1 = finalValues1.map(v => v / 100);
            const allRatiosL = finalValuesL.map(v => v / 100);
            const avgRatio1 = allRatios1.reduce((a, b) => a + b, 0) / allRatios1.length;
            const avgRatioL = allRatiosL.reduce((a, b) => a + b, 0) / allRatiosL.length;
            console.log('å…¨è©¦è¡Œã®å¹³å‡å€ç‡ L=1:', avgRatio1.toFixed(3) + 'x');
            console.log('å…¨è©¦è¡Œã®å¹³å‡å€ç‡ L=' + L + ':', avgRatioL.toFixed(3) + 'x');
            
            for (let i = 0; i < finalValues1.length; i++) {
                if (finalValuesL[i] > finalValues1[i]) {
                    leverageWins++;
                } else if (finalValuesL[i] < finalValues1[i]) {
                    normalWins++;
                } else {
                    ties++;
                }
            }
            
            console.log('ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFå‹åˆ©:', leverageWins);
            console.log('é€šå¸¸ETFå‹åˆ©:', normalWins);
            console.log('å¼•ãåˆ†ã‘:', ties);
            
            // ç†è«–çš„ãªä¸­å¤®å€¤ã‚’è¨ˆç®—ï¼ˆ100ä¸‡å††ãƒ™ãƒ¼ã‚¹ï¼‰
            const params1 = getParams(1, parseFloat(document.getElementById('mu').value), 
                                     parseFloat(document.getElementById('sigma').value),
                                     parseFloat(document.getElementById('b').value),
                                     parseFloat(document.getElementById('c').value), T);
            const paramsL = getParams(L, parseFloat(document.getElementById('mu').value),
                                     parseFloat(document.getElementById('sigma').value),
                                     parseFloat(document.getElementById('b').value),
                                     parseFloat(document.getElementById('c').value), T);
            
            const theoreticalMedian1 = 100 * Math.exp(params1.alpha);
            const theoreticalMedianL = 100 * Math.exp(paramsL.alpha);
            
            console.log('\n=== ç†è«–å€¤ã¨ã®æ¯”è¼ƒ ===');
            console.log('ç†è«–ä¸­å¤®å€¤ L=1:', theoreticalMedian1.toFixed(2) + 'ä¸‡å†† (' + (theoreticalMedian1/100).toFixed(3) + 'x)');
            console.log('ç†è«–ä¸­å¤®å€¤ L=' + L + ':', theoreticalMedianL.toFixed(2) + 'ä¸‡å†† (' + (theoreticalMedianL/100).toFixed(3) + 'x)');
            console.log('ç†è«–ä¸­å¤®å€¤æ¯”:', (theoreticalMedianL / theoreticalMedian1).toFixed(3));
            
            // å®Ÿæ¸¬ä¸­å¤®å€¤
            const sortedValues1 = [...finalValues1].sort((a, b) => a - b);
            const sortedValuesL = [...finalValuesL].sort((a, b) => a - b);
            const actualMedian1 = sortedValues1[Math.floor(sortedValues1.length / 2)];
            const actualMedianL = sortedValuesL[Math.floor(sortedValuesL.length / 2)];
            console.log('å®Ÿæ¸¬ä¸­å¤®å€¤ L=1:', actualMedian1.toFixed(2) + 'ä¸‡å†† (' + (actualMedian1/100).toFixed(3) + 'x)');
            console.log('å®Ÿæ¸¬ä¸­å¤®å€¤ L=' + L + ':', actualMedianL.toFixed(2) + 'ä¸‡å†† (' + (actualMedianL/100).toFixed(3) + 'x)');
            
            if (theoreticalMedianL > theoreticalMedian1) {
                console.log('âœ“ ç†è«–çš„ã«ã¯ã€ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFã®ä¸­å¤®å€¤ã®æ–¹ãŒé«˜ã„ â†’ å‹ç‡50%ä»¥ä¸ŠãŒæœŸå¾…ã•ã‚Œã‚‹');
            } else {
                console.log('âœ“ ç†è«–çš„ã«ã¯ã€é€šå¸¸ETFã®ä¸­å¤®å€¤ã®æ–¹ãŒé«˜ã„ â†’ ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFå‹ç‡50%ä»¥ä¸‹ãŒæœŸå¾…ã•ã‚Œã‚‹');
            }
            
            const expectedWinRate = theoreticalMedianL > theoreticalMedian1 ? '> 50%' : '< 50%';
            console.log('æœŸå¾…ã•ã‚Œã‚‹å‹ç‡ï¼ˆç†è«–å€¤ï¼‰:', expectedWinRate);
            
            const totalTrials = leverageWins + normalWins + ties;
            const leverageWinRate = (leverageWins / totalTrials * 100).toFixed(1);
            const normalWinRate = (normalWins / totalTrials * 100).toFixed(1);
            
            console.log('\n=== æœ€çµ‚çµæœ ===');
            console.log('ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETFå‹ç‡ï¼ˆå®Ÿæ¸¬ï¼‰:', leverageWinRate + '%');
            console.log('é€šå¸¸ETFå‹ç‡ï¼ˆå®Ÿæ¸¬ï¼‰:', normalWinRate + '%');
            
            // ç†è«–å€¤ã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
            const theoreticalExpectedWinRate = theoreticalMedianL > theoreticalMedian1 ? '> 50%' : '< 50%';
            const actualIsConsistent = (theoreticalMedianL > theoreticalMedian1 && leverageWins > normalWins) ||
                                      (theoreticalMedianL < theoreticalMedian1 && leverageWins < normalWins);
            
            if (actualIsConsistent) {
                console.log('âœ“ çµæœã¯ç†è«–å€¤ã¨æ•´åˆã—ã¦ã„ã‚‹ï¼ˆæœŸå¾…: ' + theoreticalExpectedWinRate + 'ï¼‰');
            } else {
                console.log('âš ï¸ çµæœãŒç†è«–å€¤ã¨ä¸æ•´åˆï¼ˆæœŸå¾…: ' + theoreticalExpectedWinRate + 'ã€å®Ÿæ¸¬: ' + leverageWinRate + '%ï¼‰');
                console.log('   è©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™ã¨ç†è«–å€¤ã«è¿‘ã¥ãã¾ã™');
            }
            console.log('==================\n');
            
            // UIæ›´æ–°
            document.getElementById('chart4-win-simulations').textContent = totalTrials;
            document.getElementById('chart4-period-display').textContent = T;
            document.getElementById('win-L-display').textContent = L.toFixed(1);
            document.getElementById('win-L-display2').textContent = L.toFixed(1);
            document.getElementById('leverage-wins').textContent = leverageWins + 'å›';
            document.getElementById('normal-wins').textContent = normalWins + 'å›';
            document.getElementById('leverage-win-rate').textContent = leverageWinRate + '%';
            document.getElementById('normal-win-rate').textContent = normalWinRate + '%';
            
            // Chart.jsã§å††ã‚°ãƒ©ãƒ•ã‚’æç”»
            const ctx = document.getElementById('win-loss-chart').getContext('2d');
            
            winLossChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [
                        `L=${L.toFixed(1)} å‹åˆ© (${leverageWinRate}%)`,
                        `L=1 å‹åˆ© (${normalWinRate}%)`
                    ],
                    datasets: [{
                        data: [leverageWins, normalWins],
                        backgroundColor: [
                            'rgba(255, 140, 0, 0.8)',
                            'rgba(0, 100, 255, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 140, 0, 1)',
                            'rgba(0, 100, 255, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: 13 },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}å›`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ã‚°ãƒ©ãƒ•5: ç ´ç”£ç¢ºç‡ã®æ£’ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateBankruptcyChart(finalValues1, finalValuesL, L, T, numSimulations, initialValue) {
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (bankruptcyChart) {
                bankruptcyChart.destroy();
            }
            
            // ç ´ç”£ã®å®šç¾©: è³‡ç”£ãŒåˆæœŸå€¤ã®1/4ä»¥ä¸‹ã«ãªã‚‹ã“ã¨
            const bankruptcyThreshold = initialValue / 4;
            
            // ç ´ç”£å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const normalBankruptcyCount = finalValues1.filter(v => v <= bankruptcyThreshold).length;
            const leverageBankruptcyCount = finalValuesL.filter(v => v <= bankruptcyThreshold).length;
            
            // ç ´ç”£ç¢ºç‡ã‚’è¨ˆç®—ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰
            const normalBankruptcyRate = ((normalBankruptcyCount / numSimulations) * 100).toFixed(1);
            const leverageBankruptcyRate = ((leverageBankruptcyCount / numSimulations) * 100).toFixed(1);
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            console.log('\n========== ç ´ç”£ç¢ºç‡åˆ†æ ==========');
            console.log('æœŸé–“: ' + T + 'å¹´');
            console.log('è©¦è¡Œå›æ•°: ' + numSimulations + 'å›');
            console.log('åˆæœŸæŠ•è³‡é¡: ' + initialValue + 'ä¸‡å††');
            console.log('ç ´ç”£åŸºæº–: ' + bankruptcyThreshold + 'ä¸‡å††ä»¥ä¸‹ï¼ˆåˆæœŸå€¤ã®1/4ï¼‰');
            console.log('\nL=1 é€šå¸¸ETF:');
            console.log('  ç ´ç”£å›æ•°: ' + normalBankruptcyCount + 'å›');
            console.log('  ç ´ç”£ç¢ºç‡: ' + normalBankruptcyRate + '%');
            console.log('\nL=' + L + ' ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF:');
            console.log('  ç ´ç”£å›æ•°: ' + leverageBankruptcyCount + 'å›');
            console.log('  ç ´ç”£ç¢ºç‡: ' + leverageBankruptcyRate + '%');
            console.log('\nç ´ç”£ãƒªã‚¹ã‚¯å·®: ' + (leverageBankruptcyRate - normalBankruptcyRate).toFixed(1) + '% ãƒã‚¤ãƒ³ãƒˆ');
            console.log('==================\n');
            
            // UIæ›´æ–°
            document.getElementById('chart5-simulations').textContent = numSimulations;
            document.getElementById('chart5-period-display').textContent = T;
            document.getElementById('bankruptcy-L-display').textContent = L.toFixed(1);
            document.getElementById('normal-bankruptcy-rate').textContent = normalBankruptcyRate + '%';
            document.getElementById('normal-bankruptcy-count').textContent = normalBankruptcyCount + 'å›';
            document.getElementById('leverage-bankruptcy-rate').textContent = leverageBankruptcyRate + '%';
            document.getElementById('leverage-bankruptcy-count').textContent = leverageBankruptcyCount + 'å›';
            
            // Chart.jsã§æ£’ã‚°ãƒ©ãƒ•ã‚’æç”»
            const ctx = document.getElementById('bankruptcy-chart').getContext('2d');
            
            bankruptcyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['L=1 é€šå¸¸ETF', `L=${L.toFixed(1)} ãƒ¬ãƒãƒ¬ãƒƒã‚¸ETF`],
                    datasets: [{
                        label: 'ç ´ç”£ç¢ºç‡ (%)',
                        data: [parseFloat(normalBankruptcyRate), parseFloat(leverageBankruptcyRate)],
                        backgroundColor: [
                            'rgba(0, 100, 255, 0.7)',
                            'rgba(255, 140, 0, 0.7)'
                        ],
                        borderColor: [
                            'rgba(0, 100, 255, 1)',
                            'rgba(255, 140, 0, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'ç ´ç”£ç¢ºç‡ (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ETFã‚¿ã‚¤ãƒ—',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const index = context.dataIndex;
                                    const count = index === 0 ? normalBankruptcyCount : leverageBankruptcyCount;
                                    return [
                                        'ç ´ç”£ç¢ºç‡: ' + value.toFixed(1) + '%',
                                        'ç ´ç”£å›æ•°: ' + count + '/' + numSimulations + 'å›'
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ã‚¹ã‚±ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        window.isLogScale = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«
        
        document.getElementById('toggle-log-scale').addEventListener('click', function() {
            window.isLogScale = !window.isLogScale;
            
            const button = document.getElementById('toggle-log-scale');
            button.textContent = window.isLogScale ? 'ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆ‡æ›¿' : 'å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆ‡æ›¿';
            
            if (window.montecarloData) {
                const yAxisConfig = window.isLogScale 
                    ? { title: 'è³‡ç”£é¡ (ä¸‡å††)', type: 'log' }
                    : { title: 'è³‡ç”£é¡ (ä¸‡å††)', type: 'linear', range: [0, window.linearYMax || 1000] };
                
                const layout = {
                    xaxis: { title: 'æŠ•è³‡å¹´æ•°', range: [0, window.montecarloT] },
                    yaxis: yAxisConfig,
                    showlegend: true,
                    legend: { x: 0.02, y: 0.98 },
                    margin: { l: 60, r: 20, t: 20, b: 60 },
                    height: 500
                };
                
                Plotly.newPlot('montecarlo-chart', window.montecarloData, layout, {responsive: true});
            }
        });
        
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã®è¡¨ç¤ºã®ã¿æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateDisplayValues() {
            const T = parseInt(document.getElementById('T').value);
            const L = parseFloat(document.getElementById('L').value);
            const mu = parseFloat(document.getElementById('mu').value);
            const sigma = parseFloat(document.getElementById('sigma').value);
            const b = parseFloat(document.getElementById('b').value);
            const c = parseFloat(document.getElementById('c').value);
            const numSimulations = parseInt(document.getElementById('simulations').value);
            const yMax = parseInt(document.getElementById('ymax').value);
            
            document.getElementById('T-value').textContent = T;
            document.getElementById('L-value').textContent = L.toFixed(1);
            document.getElementById('mu-value').textContent = mu.toFixed(2);
            document.getElementById('sigma-value').textContent = sigma.toFixed(2);
            document.getElementById('b-value').textContent = b.toFixed(3);
            document.getElementById('c-value').textContent = c.toFixed(4);
            document.getElementById('simulations-value').textContent = numSimulations;
            document.getElementById('ymax-value').textContent = yMax;
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆå€¤ã®è¡¨ç¤ºã®ã¿æ›´æ–°ï¼‰
        const inputs = ['T', 'L', 'mu', 'sigma', 'b', 'c', 'simulations', 'ymax'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', updateDisplayValues);
        });
        
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒœã‚¿ãƒ³
        document.getElementById('run-simulation').addEventListener('click', function() {
            const button = document.getElementById('run-simulation');
            const loading = document.getElementById('loading');
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            button.disabled = true;
            button.textContent = 'â³ å®Ÿè¡Œä¸­...';
            loading.style.display = 'block';
            
            // å°‘ã—é…å»¶ã•ã›ã¦UIã‚’æ›´æ–°
            setTimeout(() => {
                updateCharts();
                
                // å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                button.disabled = false;
                button.textContent = 'ğŸš€ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ';
                loading.style.display = 'none';
            }, 100);
        });
        
        // ã‚°ãƒ©ãƒ•4ã®Xè»¸ã‚¹ã‚±ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('toggle-dist-x-scale').addEventListener('click', function() {
            distScaleState.xScale = distScaleState.xScale === 'logarithmic' ? 'linear' : 'logarithmic';
            this.textContent = distScaleState.xScale === 'logarithmic' ? 'Xè»¸: ç·šå½¢ã«åˆ‡æ›¿' : 'Xè»¸: å¯¾æ•°ã«åˆ‡æ›¿';
            
            // ã‚°ãƒ©ãƒ•ã‚’å†æç”»ï¼ˆæœ€å¾Œã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ä½¿ç”¨ï¼‰
            if (window.lastDistributionData) {
                updateDistributionChart(
                    window.lastDistributionData.finalRatios1,
                    window.lastDistributionData.finalRatiosL,
                    window.lastDistributionData.L,
                    window.lastDistributionData.T,
                    window.lastDistributionData.params1,
                    window.lastDistributionData.paramsL,
                    window.lastDistributionData.theoryMean1,
                    window.lastDistributionData.theoryMedian1,
                    window.lastDistributionData.theoryMeanL,
                    window.lastDistributionData.theoryMedianL
                );
            }
        });
        
        // ã‚°ãƒ©ãƒ•4ã®Yè»¸ã‚¹ã‚±ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('toggle-dist-y-scale').addEventListener('click', function() {
            distScaleState.yScale = distScaleState.yScale === 'linear' ? 'logarithmic' : 'linear';
            this.textContent = distScaleState.yScale === 'linear' ? 'Yè»¸: å¯¾æ•°ã«åˆ‡æ›¿' : 'Yè»¸: ç·šå½¢ã«åˆ‡æ›¿';
            
            // ã‚°ãƒ©ãƒ•ã‚’å†æç”»ï¼ˆæœ€å¾Œã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ä½¿ç”¨ï¼‰
            if (window.lastDistributionData) {
                updateDistributionChart(
                    window.lastDistributionData.finalRatios1,
                    window.lastDistributionData.finalRatiosL,
                    window.lastDistributionData.L,
                    window.lastDistributionData.T,
                    window.lastDistributionData.params1,
                    window.lastDistributionData.paramsL,
                    window.lastDistributionData.theoryMean1,
                    window.lastDistributionData.theoryMedian1,
                    window.lastDistributionData.theoryMeanL,
                    window.lastDistributionData.theoryMedianL
                );
            }
        });
        
        // åˆæœŸæç”»
        updateCharts();
        
        // MathJaxã®æ•°å¼ã‚’è¡¨ç¤º
        function renderFormula() {
            const formulaDiv = document.getElementById('formula-display');
            formulaDiv.innerHTML = '\\[\\approx R^L \\times e^{-\\frac{1}{2}L(L-1)\\sigma^2} \\times e^{-(L-1)b} \\times e^{-c}\\]';
            
            document.getElementById('label-1').innerHTML = '\\(R^L\\)';
            document.getElementById('label-2').innerHTML = '\\(e^{-\\frac{1}{2}L(L-1)\\sigma^2}\\)';
            document.getElementById('label-3').innerHTML = '\\(e^{-(L-1)b}\\)';
            document.getElementById('label-4').innerHTML = '\\(e^{-c}\\)';
            
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ•°å¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        window.addEventListener('load', renderFormula);
    </script>
</body>
</html>
